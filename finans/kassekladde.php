
<?php
//                ___   _   _   ___  _     ___  _ _
//               / __| / \ | | |   \| |   |   \| / /
//               \__ \/ _ \| |_| |) | | _ | |) |  <
//               |___/_/ \_|___|___/|_||_||___/|_\_\
//
// --- finans/kassekladde.php --- ver 4.1.0 --- 2024-04-19 ---
// LICENSE
//
// This program is free software. You can redistribute it and / or
// modify it under the terms of the GNU General Public License (GPL)
// which is published by The Free Software Foundation; either in version 2
// of this license or later version of your choice.
// However, respect the following:
// 
// It is forbidden to use this program in competition with Saldi.DK ApS
// or other proprietor of the program without prior written agreement.
//
// The program is published with the hope that it will be beneficial,
// but WITHOUT ANY KIND OF CLAIM OR WARRANTY.
// See GNU General Public License for more details.
//
// Copyright (c) 2003-2024 Saldi.dk ApS
// ----------------------------------------------------------------------

// 20120809 søg 20120809 V. openpostopslag viser både kreditorer og debitorer hvis de har samme kontonr - rettet 
// 20120806 søg 20120806
// 20121110 søg 20121110
// 20130221 søg 20130221
// 20130404 addslashes erstattet af db_escape_string
// 20130731 db_escape_string fjernet 2 steder da den bruges senere på samme streng og fordoblede "'" ved hver gem.
// 20131101 Fravalg for tjek af forskellige datoer.Søg: $forskellige_datoer
// 20131216	Flyttet javascript og ned til de øvrige scripts og fjernet fejltastet "f"
// 20140624 Flyttet opslag efter im betalings_id skal vises over $_POST så den også er med når kladden åbnes. Søg 20140624
// 20140624 Indsat $gl_transdate[$x] Søg 20140624
// 20140601 Tilføjet intern_bilag - Søg intern_bilag.
// 20140709 Et cfirede kontonumre blev set som genvejstast og gav fejl.Søg "!is_numeric"   
// 20140718 Indsat db_escape_string i beskrivelse for 'tilbagefør' Søg 20140718 
// 20141106	Clips vises ikke før der er et kladde id 20141106
// 20150105 db_escape_string på kladdenote 20150105
// 20150105 Fejltjek på bilagsnummer v. kopier til ny 20150105-2
// 20150120 Saldo vises ved kontopslag i funktion finansopslag. 
// 20150521 Indsat begrænsning på antal bilag der kan tilføjes #20150521
// 20151210 Indført brug af piletaster ctrl-pil - søg formnavi
// 20151210	Kontrol for dubletposteringer. Søg dublet & $dub
// 20170321 Forbedring af søgning ved opslag således at finans, debitor & kreditorkonto lister de konto hvor teksten indgår.
// 20170418 Tilføjet '&& !$faktura[$x]' så der kan laves opslag på falturanr samt ($submit!='Opslag' &&) så der kan laves opslag uden feltindhold. 20170418
// 20170419 Det autogenererede bilagsnr blev stående hvis nederste linje blev slettet.
// 20171129 Bilagsnummer manglede ved import når der var oprette kladdelinjer Søg 20171129
// 20180618 Tilføjet "Vend fortegn" ved 'kopier til ny' Søg $vend_fortegn
// 20181118	Definition af variabler.
// 20190116 MSC - Rettet topdesign til for kopir kassekladde.
// 20190131 MSC - Rettet topmenu design til.
// 20190201 MSC - Rettet isset fejl
// 20190105 MSC - Rettet topmenu design til og rettet isset fejl
// 20190206 MSC - Rettet isset fejl
// 20190213 MSC - Rettet isset fejl
// 20190312 MSC - Rettet isset fejl
// 20190503 PHR	- Corrected error in name lookup as Company names with Danish Chars were not found. 20190503
// 20190605 PHR - Error in call to jquery-1.10.2.min.js. Thanks to Rune Grysbæk, RGProducts 
// 20190625 PHR	- +x after annex no. added twice the number wanted. 20190625
// 20190830 PHR - function 'kopier til ny'. d_type & k_type was not switched when using 'Vend fortegn'. 
// 20191124 PHR - function 'kopier til ny'. d_type & k_type was, by mistake, multiplied by 1.
// 20210211 PHR - Some cleanup
// 20210628 LOE - Did some text translations.
// 20210720 LOE - Did translations on title tags and alert texts
// 20210721 LOE - Did translations on $submit buttons
// 20210920 PHR - Autogenerated line was not removed when above lines balanced 
// 20221018 PHR - Changed name='submit' to a more meaningfull name and set $submit to whatever is submitted.
// 20230302 CA  - PHP8 short cut to delete lines in daily journals
// 20230322 CA  - Showing a control accout balance is now depending on the actual financial transactions
// 20230627 PHR - Improvement of text display for financial accounts
// 20230707 LOE - Added modifications for handling kassekladde attachments
// 20230710	LOE - Some updates
// 20230720 CA  - Corrected error so balance adding from primo amount when showing control account balance
// 20230724 LOE - Some modifications + 20230727
// 20230806 LOE - Enables attachment's buttons to be visible when kasselade_id already exists
// 20230822 MSC - Copied and pasted new design code into this file
// 20231023 PHR - Added 'saldo' from bank	statement
// 20240112 LOE - Worked on drag and drop functionality for for pdf file/(now moved to documents file).
// 20240115 LOE - Css for the drag & drop func. moved to a separate file
// 20240329 PHR - Alert when clicking clip, if not saved
// 20240331 PHR - Prevent deletion of line if document attached
// 20240401 PHR - Removed reset of '$kontrolsaldo' Why was it there?
// 20240419	PHR - Corrected error in currency (valuta) 

ini_set('display_errors', 1);
ob_start(); //Starter output buffering

@session_start();
$s_id=session_id();
$title = "Kassekladde";
$modulnr=2;
$css="../css/standard.css";
$afd = $amount = $ansat = $ansat_id = $belob = $beskrivelse = $betal_id = $bilag = $dato = $d_type = $debet = array();
$faktura = $forfaldsdate = $forfaldsdato = $id = $k_type = $kontonr = $kredit = $lobenr = $momsfri = $projekt = $valuta = array();

$antal_ex=NULL;
$belob_ligslut = $belob_ligstart = $beskrivelse_ligslut = NULL;
$beskrivelse_ligstart = $bogfort = NULL;
$dato_ligslut=$dato_ligstart=$debet_ligslut=$debet_ligstart=$d_type_ligslut=$d_type_ligstart=NULL;
$faktura_ligstart = $faktura_ligslut = $find = $fokus = NULL;
$intern_bilag=NULL;
$k_type_ligslut = $k_type_ligstart = NULL;
$kredit_ligslut = $kredit_ligstart = $kladde_id = $kladdenote = $kontrolkonto = $regnstart = NULL;
$lukket=$linjebg=$opslag_id=NULL;
$restlig=NULL;
$simuler=$sletrest=$sletstart=$sletslut=$submit=NULL;
$vis_afd=	$vis_ansat=$vis_bet_liste=$vis_forfald=$vis_projekt=$vis_valuta=NULL;
$control_bal_fetched = FALSE;
$control_bal_last = $control_next_date = $control_record_daet = $titletxt = NULL;
$fejl = $kontrolsaldo = $kontrolsum = $x = $y = 0;


if (!isset($kontrolmoms))
	$kontrolmoms = NULL;
if (!isset($dub_bilag))
	$dub_bilag = NULL;
if (!isset($a))
	$a = NULL;
if (!isset($b))
	$b = NULL;
if (!isset($c))
	$c = NULL;


include("../includes/connect.php");
include("../includes/online.php");
include("../includes/std_func.php");
include("../includes/forfaldsdag.php");
print '<script src="../javascript/jquery-3.6.4.min.js"></script>';
print "<script LANGUAGE='javascript' TYPE='text/javascript' SRC='../javascript/confirmclose.js'></script>";
print "<script LANGUAGE='JavaScript' TYPE='text/javascript' SRC='../javascript/overlib.js'></script>";
print "<script>
	function fokuser(that, fgcolor, bgcolor){
		that.style.color = fgcolor;
		that.style.backgroundColor = bgcolor;
		document.forms[0].fokus.value=that.name;
	}
		function defokuser(that, fgcolor, bgcolor){
		that.style.color = fgcolor;
		that.style.backgroundColor = bgcolor;
	}
</script>";

if (!isset($tidspkt))
	$tidspkt = 0;
if (!isset($row['tidspkt']))
	$row['tidspkt'] = null;

$visipop=if_isset($_GET['visipop']);
$udskriv=if_isset($_GET['udskriv']);
if ($tjek=if_isset($_GET['tjek'])) {
	$tidspkt=microtime() ;
	list ($a,$b)=explode(" ",$tidspkt);
	$qtxt = "select bogfort,tidspkt,hvem from kladdeliste where (bogfort = '-' or bogfort = 'S') and id = $tjek";
	$query = db_select($qtxt,__FILE__ . " linje " . __LINE__);
	$row = db_fetch_array($query);
	if (isset($row['tidspkt'])) {
		list ($a,$c)=explode(" ",$row['tidspkt']);
		if (($b-$c<3600)&&($row['hvem']!=$brugernavn)){
           $alert1= findtekst(1577, $sprog_id); 
			print "<body onload=\"javascript:alert('$alert1 $row[hvem]')\">"; #20210720
			if ($popup || $visipop)
				print "<meta http-equiv='refresh' content='0;URL=../includes/luk.php'>";
			else
				print "<meta http-equiv='refresh' content='0;URL=../finans/kladdeliste.php'>";
		} else {
			$a--;
			$tidspkt=$a." ".$b; #der fratraekkes 1. sec af hensyn til refreshtjek;
			db_modify("update kladdeliste set hvem = '$brugernavn',tidspkt='$tidspkt' where id = '$tjek'",__FILE__ . " linje " . __LINE__);
		}
	}
	if (db_fetch_array(db_select("select id from tmpkassekl where kladde_id='$tjek'", __FILE__ . " linje " . __LINE__)))
		$fejl = 1;
	else
		$fejl = 0;

	if ($r=db_fetch_array(db_select("select * from grupper where ART = 'KASKL' and kode='1' and kodenr='$bruger_id'",__FILE__ . " linje " . __LINE__))) {
		$kksort=$r['box1'];
		$kontrolkonto=$r['box2'];
	} else {
		db_modify ("insert into grupper (beskrivelse,art,kode,kodenr) values ('Kassekladde','KASKL','1','$bruger_id')",__FILE__ . " linje " . __LINE__);
	}
}

$ompost=isset($_GET['ompost'])? $_GET['ompost']:Null;
if ($ompost)
	ompost($ompost);

$kladde_id=isset($_POST['kladde_id'])? $_POST['kladde_id']:0;
$antal_ny=isset($_POST['antal_ny'])? $_POST['antal_ny']:0;
$h=$antal_ny*10+100;

?>
<script type="text/javascript">
<!--
function simuler(){
window.open("../finans/bogfor.php?kladde_id=<?php echo $kladde_id?>&funktion=simuler","","width=800,height=600,scrollbars=1,resizable=1")
}
//-->
</script>
<script type="text/javascript">
<!--
function bogfor() {
	window.open("../finans/bogfor.php?kladde_id=<?php echo $kladde_id?>","","width=800,height=600,scrollbars=1,resizable=1")
}
//-->
</script>

<?php
$r=db_fetch_array(db_select("select box4,box10 from grupper where art = 'DIV' and kodenr = '2'",__FILE__ . " linje " . __LINE__)); #20140624
($r['box4'])?$forskellige_datoer=1:$forskellige_datoer=0;
($r['box10'])?$vis_bet_id=1:$vis_bet_id=0;
if($_GET) {
	$returside=if_isset($_GET['returside']);
	if (!$returside)          $returside = "../finans/kladdeliste.php'";
	if (isset($_GET['fokus'])) $fokus = $_GET['fokus'];
	$sort=if_isset($_GET['sort']);
	$kksort=if_isset($_GET['kksort']); #sortering i kassekladde
	$funktion=if_isset($_GET['funktion']);
	$x = (int) if_isset($_GET['x'], 0);
	$id[$x]=if_isset($_GET['id']);
	$lobenr[$x]=if_isset($_GET['lobenr']);
	$kladde_id = (int) if_isset($_GET['kladde_id'], 0);
	$bilag[$x] = (int) if_isset($_GET['bilag'], 0);
	$dato[$x]=if_isset($_GET['dato']);
	$beskrivelse[$x]=if_isset($_GET['beskrivelse']);
	$d_type[$x]=if_isset($_GET['d_type']);
	$debet[$x]=if_isset($_GET['debet']);
	$k_type[$x]=if_isset($_GET['k_type']);
	$kredit[$x]=if_isset($_GET['kredit']);
	$faktura[$x]=if_isset($_GET['faktura']);
	$belob[$x]=if_isset($_GET['belob']);
	$momsfri[$x]=if_isset($_GET['momsfri']);
	$afd[$x]=if_isset($_GET['afd']);
	$projekt[$x]=if_isset($_GET['projekt']);
	$ansat[$x]=if_isset($_GET['ansat']);
	$valuta[$x]=if_isset($_GET['valuta']);
	$find=if_isset($_GET['find']);
	$beskrivelse[$x]=trim($beskrivelse[$x]);
	$d_type[$x]=trim($d_type[$x]);
	$debet[$x]=trim($debet[$x]);
	$k_type[$x]=trim($k_type[$x]);
	$kredit[$x]=trim($kredit[$x]);
	$faktura[$x]=trim($faktura[$x]);
	$belob[$x]=trim($belob[$x]);

	if (!isset($forfaldsdato[$x]))
		$forfaldsdato[$x] = NULL;
	if (!isset($betal_id[$x]))
		$betal_id[$x] = '';
	
	if ($kksort)
		db_modify("update grupper set box1='$kksort' where ART='KASKL' and kode='1' and kodenr='$bruger_id'", __FILE__ . " linje " . __LINE__);
	if (($sort)&&($funktion)) {
		$funktion($find,$sort,$fokus,$x,$id[$x],$kladde_id,$bilag[$x],$dato[$x],$beskrivelse[$x],$d_type[$x],$debet[$x],$k_type[$x],$kredit[$x],$faktura[$x],$belob[$x],$momsfri[$x],$afd[$x],$projekt[$x],$ansat[$x],$valuta[$x],$forfaldsdato[$x],$betal_id[$x],$lobenr[$x]);
	}
	$y=0;
	$query = db_select("select kontonr from kontoplan where kontotype != 'H' and kontotype != 'Z' and regnskabsaar='$regnaar'",__FILE__ . " linje " . __LINE__);
	while($row = db_fetch_array($query)) {
		$y++;
		$kontonr[$y]=trim($row['kontonr']);
	}
	if ($kladde_id) {
		$qtxt = "select bogfort from kladdeliste where id = $kladde_id"; #echo __line__." $qtxt<br>";
		$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
		if ($r['bogfort'] == '-' && ($id[$x]) || ($lobenr[$x] || ($x))) {
			if ($id[$x]) {
				$qtxt = "update tmpkassekl set beskrivelse='". db_escape_string($beskrivelse[$x]) ."',d_type='$d_type[$x]', ";
				$qtxt.= "debet='$debet[$x]', k_type='$k_type[$x]', kredit='$kredit[$x]', faktura='". db_escape_string($faktura[$x]) ."',";
				$qtxt.= "amount='$belob[$x]', momsfri='$momsfri[$x]', afd='$afd[$x]', projekt='$projekt[$x]', ansat='$ansat[$x]',";
				$qtxt.= "valuta='$valuta[$x]',forfaldsdate='$forfaldsdato[$x]',betal_id='$betal_id[$x]' ";
				$qtxt.= "where id='$id[$x]' and kladde_id='$kladde_id'";
			}	elseif ($lobenr[$x]) {
				$qtxt = "update tmpkassekl set bilag='$bilag[$x]',beskrivelse='". db_escape_string($beskrivelse[$x]) ."',d_type='$d_type[$x]',";
				$qtxt.= "debet='$debet[$x]', k_type='$k_type[$x]', kredit='$kredit[$x]', faktura='". db_escape_string($faktura[$x]) ."',";
				$qtxt.= "amount='$belob[$x]', momsfri='$momsfri[$x]', afd='$afd[$x]', projekt='$projekt[$x]', ansat='$ansat[$x]',"; 
				$qtxt.= "valuta='$valuta[$x]',forfaldsdate='$forfaldsdato[$x]',betal_id='$betal_id[$x]' ";
				$qtxt.= "where lobenr='$lobenr[$x]' and kladde_id='$kladde_id'";
			} else {
				$qtxt = "update tmpkassekl set bilag='$bilag[$x]',d_type='$d_type[$x]', debet='$debet[$x]', k_type='$k_type[$x]', ";
				$qtxt.= "kredit='$kredit[$x]', faktura='". db_escape_string($faktura[$x]) ."', amount='$belob[$x]', momsfri='$momsfri[$x]',";
				$qtxt.= "afd='$afd[$x]', projekt='$projekt[$x]', ansat='$ansat[$x]', valuta='$valuta[$x]',forfaldsdate='$forfaldsdato[$x]',";
				$qtxt.= "betal_id='$betal_id[$x]' where lobenr='$x' and kladde_id='$kladde_id'";
			}
			db_modify($qtxt,__FILE__ . " linje " . __LINE__);
			kontroller($id[$x],$bilag[$x],$dato[$x],$beskrivelse[$x],$d_type[$x],$debet[$x],$k_type[$x],$kredit[$x],$faktura[$x],$belob[$x],$momsfri[$x],$kontonr[$x],$kladde_id,$afd[$x],$projekt[$x],$ansat[$x],$valuta[$x],$forfaldsdato[$x],$betal_id[$x],$x);
		}
		if ($fejl)
			$submit = 'save';
	}
	if ($r=db_fetch_array(db_select("select * from grupper where ART = 'KASKL' and kode='1' and kodenr='$bruger_id'",__FILE__ . " linje " . __LINE__))) {
		$kksort=$r['box1'];
		$kontrolkonto=$r['box2'];
	}
}

if ($_POST) {
	if (isset($_POST['copy2new'])     && $_POST['copy2new']) $submit = 'copy2new';
	elseif (isset($_POST['import'])   && $_POST['import']  ) $submit = 'import';
	elseif (isset($_POST['lookup'])   && $_POST['lookup']  ) $submit = 'lookup';
	elseif (isset($_POST['doPost'])   && $_POST['doPost']  ) $submit = 'doPost';
	elseif (isset($_POST['revert'])   && $_POST['revert']  ) $submit = 'revert';
	elseif (isset($_POST['offset'])   && $_POST['offset']  ) $submit = 'offset';
	elseif (isset($_POST['save'])     && $_POST['save']    ) $submit = 'save';
	elseif (isset($_POST['simulate']) && $_POST['simulate']) $submit = 'simulate';
	elseif (isset($_POST['upload'])   && $_POST['upload']  ) $submit = 'upload';
	else $submit =trim(if_isset($_POST['submit']));
	$tidspkt =if_isset($_POST['tidspkt']);
	$kladde_id =if_isset($_POST['kladde_id']);
	$ny_dato =if_isset($_POST['ny_dato']);
	$vend_fortegn=if_isset($_POST['vend_fortegn']);
	$kontrolkonto=trim(if_isset($_POST['kontrolkonto']));
	$bilagsnr=if_isset($_POST['bilagsnr']);
	$kladdenote = db_escape_string(trim(if_isset($_POST['kladdenote'])));
	$ny_kladdenote = db_escape_string(trim(if_isset($_POST['ny_kladdenote'])));
	$antal_ny=if_isset($_POST['antal_ny']);
	$antal_ex=if_isset($_POST['antal_ex']);
	$fokus=if_isset($_POST['fokus']);
//$momsfri       = if_isset($_POST['momsfri']);
	$id=if_isset($_POST['id']);
	$gl_transdate=if_isset($_POST['transdate']);

	if ($kladde_id) {
#		if ($r=db_fetch_array(db_select("select id from kladdeliste where bogfort='S' and id='$kladde_id'",__FILE__ . " linje " . __LINE__))) {
#			 $alerttekst= findtekst(1417, $sprog_id);
#			 alert('a'.$alerttekst);
#		}
		db_modify("delete from tmpkassekl where kladde_id=$kladde_id",__FILE__ . " linje " . __LINE__);
		if (isset($_POST['cancelSimulation']) && $_POST['cancelSimulation']) {
		db_modify("delete from simulering where kladde_id=$kladde_id",__FILE__ . " linje " . __LINE__);
		$qtxt = "update kladdeliste set bogfort = '-', bogforingsdate = NULL, bogfort_af = '' where id = '$kladde_id' and bogfort = 'S'";
		db_modify($qtxt,__FILE__ . " linje " . __LINE__);
		}
	}
	$qtxt = "update grupper set box2='$kontrolkonto' where ART='KASKL' and kode='1' and kodenr='$bruger_id'";
	db_modify($qtxt,__FILE__ . " linje " . __LINE__);
	$qtxt = "select * from grupper where ART = 'bilag' and (box6 ='on' or (box1 !='' and box2 !='' and box3 !=''))";
	($r=db_fetch_array(db_select($qtxt,__FILE__ . " linje " . __LINE__)))?$vis_bilag=1:$vis_bilag=0;
	(isset($r['box6']) && $r['box6']=='on')?$intern_bilag=1:$intern_bilag=0;
	(db_fetch_array(db_select("select * from grupper where ART = 'AFD'",__FILE__ . " linje " . __LINE__)))?$vis_afd=1:$vis_afd=0;
	(db_fetch_array(db_select("select * from grupper where ART = 'PRJ'",__FILE__ . " linje " . __LINE__)))?$vis_projekt=1:$vis_projekt=0;
	(db_fetch_array(db_select("select * from grupper where ART = 'VK'",__FILE__ . " linje " . __LINE__)))?$vis_valuta=1:$vis_valuta=0;
	for ($x=1;$x<=$antal_ny;$x++) {
		$dato[$x]=$beskrivelse[$x]=$d_type[$x]=$debet[$x]=$k_type[$x]=$kredit[$x]=$faktura[$x]=NULL;
		$belob[$x]=$momsfri[$x]=$afd[$x]=$projekt[$x]=$ansat[$x]=$valuta[$x]=$forfaldsdato[$x]=$betal_id[$x]=NULL;

		$y="bila".$x;
		$bilag[$x]=trim(if_isset($_POST[$y]));
		if (!$bilag[$x])
			$bilag[$x] = '0'; # PHR 02.09.06
		$y="dato".$x;
		$dato[$x]=trim(if_isset($_POST[$y]));
		if (substr($dato[$x], 4, 1) == '-' && substr($dato[$x], 7, 1) == '-') {
			$dato[$x] = dkdato($dato[$x]);
		}
		$y="besk".$x;
		$beskrivelse[$x]=trim(if_isset($_POST[$y])); #20130731
		while (strpos($beskrivelse[$x], "  "))
			$beskrivelse[$x] = str_replace("  ", " ", $beskrivelse[$x]);
#		while (strpos($beskrivelse[$x],"''")) $beskrivelse[$x]=str_replace("''","'",$beskrivelse[$x]); #20130731
		$y="d_ty".$x;
		$d_type[$x]=substr(strtoupper(if_isset($_POST[$y])),0,1);
		$y="debe".$x;
		$debet[$x]=trim(if_isset($_POST[$y]));
		$y="k_ty".$x;
		$k_type[$x]=substr(strtoupper(if_isset($_POST[$y])),0,1);
		$y="kred".$x;
		$kredit[$x]=trim(if_isset($_POST[$y]));
		$y="fakt".$x;
		$faktura[$x]=trim(if_isset($_POST[$y])); #20130731
		$y="belo".$x;
		$belob[$x]=if_isset($_POST[$y]);
		$y="dkka".$x;
		$dkkamount[$x]=if_isset($_POST[$y]);
		$y="afd_".$x;
		$afd[$x]=trim(if_isset($_POST[$y]));
		$y="proj".$x;
		$projekt[$x]=trim(if_isset($_POST[$y]));
		$y="meda".$x;
		$ansat[$x]=trim(if_isset($_POST[$y]));
		$y="valu".$x;
		$valuta[$x]=strtoupper(if_isset($_POST[$y]));
		$y="forf".$x;
		$forfaldsdato[$x]=trim(if_isset($_POST[$y]));
		$y="b_id".$x;
		$betal_id[$x]=trim(if_isset($_POST[$y]));
		$y="moms".$x;
		$momsfri[$x]=if_isset($_POST[$y]);
		if (is_numeric($bilag[$x])) { #20230302 - you can't subtract 1 from a string
			if (
				$submit != 'lookup' && (!$bilag[$x] || $bilag[$x] == $bilag[$x - 1] || $bilag[$x] - 1 == $bilag[$x - 1])
				&& (!$dato[$x] || $dato[$x] == $dato[$x - 1]) && (!$beskrivelse[$x] || $beskrivelse[$x] == $beskrivelse[$x - 1])
				&& !$d_type[$x] && !$k_type[$x] && !$debet[$x] && !$kredit[$x] && !$faktura[$x] && !$belob[$x]
			) {
				$bilag[$x] = '-'; #20170418
			} elseif (
				$submit != 'lookup' && (!$bilag[$x] || $bilag[$x] == $bilag[$x - 1]) && (!$dato[$x] || $dato[$x] == $dato[$x - 1])
				&& (!$beskrivelse[$x] || $beskrivelse[$x] == $beskrivelse[$x - 1]) && !$d_type[$x] && !$k_type[$x] && !$debet[$x]
				&& !$kredit[$x] && !$faktura[$x] && !$belob[$x]
			) {
				$bilag[$x] = '-'; #20230302
			}
		} elseif (!$bilag[$x] && !$dato[$x] && !$beskrivelse[$x] && !$d_type[$x] && !$k_type[$x] && !$debet[$x] && !$kredit[$x])
			$bilag[$x] = '-';
		elseif ($bilag[$x - 1] == '-' && $dato[$x] == $dato[$x - 2] && !$beskrivelse[$x] && !$d_type[$x] && !$k_type[$x] && !$debet[$x] && !$kredit[$x])
			$bilag[$x] = '-'; # 20170419
		if (($bilag[$x] == "-*"))
			$sletrest = 1;
		if ($sletrest)
			$bilag[$x] = '-';
		if (($bilag[$x] == "=*"))
			$restlig = 1;
		if ($restlig)
			$bilag[$x] = '=';
		if ($bilag[$x] == "=")
			$bilag[$x] = $bilag[$x - 1];
		if ($bilag[$x] == "+")
			$bilag[$x] = $bilag[$x - 1] + 1;
		if (substr($bilag[$x], 0, 1) == "+")
			$bilag[$x] = $bilag[$x - 1] + 1;
		if (!$dato[$x] || $dato[$x] == '=')
			$dato[$x] = $dato[$x - 1];
		if ($beskrivelse[$x] == "=")
			$beskrivelse[$x] = $beskrivelse[$x - 1];
		if ($d_type[$x] == "=")
			$d_type[$x] = $d_type[$x - 1];
		if ($debet[$x] == "=")
			$debet[$x] = $debet[$x - 1];
		if ($k_type[$x] == "=")
			$k_type[$x] = $k_type[$x - 1];
		if ($kredit[$x] == "=")
			$kredit[$x] = $kredit[$x - 1];
		if ($faktura[$x] == "=")
			$faktura[$x] = $faktura[$x - 1];
		if ($belob[$x] == "=")
			$belob[$x] = $belob[$x - 1];
		if ($afd[$x] == "=")
			$afd[$x] = $afd[$x - 1];
		if ($ansat[$x] == "=")
			$ansat[$x] = $ansat[$x - 1];
		if ($projekt[$x] == "=")
			$projekt[$x] = $projekt[$x - 1];
		if ($forfaldsdato[$x] == "=")
			$forfaldsdato[$x] = $forfaldsdato[$x - 1];
		if ($betal_id[$x] == "=")
			$betal_id[$x] = $betal_id[$x - 1];
		if ((!$dato[$x]) && (($beskrivelse[$x]) || ($debet[$x]) || ($kredit[$x])))
			$dato[$x] = date("d-m-Y");
		if ($bilag[$x] != $bilag[$x - 1])
			$kontrolsum = 0;
		if ($debet[$x])
			$kontrolsum = $kontrolsum + $dkkamount[$x];
		if ($kredit[$x])
			$kontrolsum = $kontrolsum - $dkkamount[$x];
		$bilagssum[$x]=$kontrolsum;
		# fjerner autogenererede linjer hvis bilaget er i balance
		if (!$kontrolsum && !$d_type[$x] && !$k_type[$x] && !$debet[$x] && !$kredit[$x] && $bilag[$x] == $bilag[$x - 1] && $dato[$x] == $dato[$x - 1] && $beskrivelse[$x] == $beskrivelse[$x - 1])
			$bilag[$x] = "-";
		if ((!$sletslut) && ($bilag[$x]=="->")) {
			$sletstart=$x;
			$bilag[$x]="-";
		}
		if ($bilag[$x]=="<-") {
			$bilag[$x]="-";
			if ((!$sletslut) && ($sletstart))
				$sletslut = $x;
		}
		if (($sletstart)&&($sletslut)&&($sletstart<$sletslut)) {
			for ($y=$sletstart;$y<=$sletslut;$y++) {
				$bilag[$y]="-";
				db_modify("update tmpkassekl set bilag= '$bilag[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$sletstart = '';
			$sletslut = '';
		}
## Bilag
#		if ($bilag[$x]=='-*') $sletrest=1;
#		if ($sletrest) $bilag[$x]='-';

		if (!isset($bilag_ligslut))
			$bilag_ligslut = NULL;
		if ((!$bilag_ligslut) && ($bilag[$x]=="=>")) {
			$bilag_ligstart=$x;
			$bilag[$x]=$bilag[$x-1];
		}
		if ($bilag[$x]=="<=") {
			$bilag[$x]==$bilag[$x-1];
			if ((!$bilag_ligslut) && ($bilag_ligstart))
				$bilag_ligslut = $x;
		}
		if (!isset($bilag_ligslut))
			$bilag_ligslut = NULL;
		if (!isset($bilag_ligstart))
			$bilag_ligstart = NULL;
		if (($bilag_ligstart)&&($bilag_ligslut)&&($bilag_ligstart<$bilag_ligslut)) {
			for ($y=$bilag_ligstart;$y<=$bilag_ligslut;$y++) {
				$bilag[$y]=$bilag[$y-1];
				db_modify("update tmpkassekl set bilag= '$bilag[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$bilag_ligstart = '';
			$bilag_ligslut = '';
		}
# Dato
		if ((!$dato_ligslut) && ($dato[$x]=="=>")) {
			$dato_ligstart=$x;
			$dato[$x]=$dato[$x-1];
		}
		if ($dato[$x]=="<=") {
			$dato[$x]==$dato[$x-1];
			if ((!$dato_ligslut) && ($dato_ligstart))
				$dato_ligslut = $x;
		}
		if (($dato_ligstart)&&($dato_ligslut)&&($dato_ligstart<$dato_ligslut)) {
			for ($y=$dato_ligstart;$y<=$dato_ligslut;$y++) {
				$dato[$y]=$dato[$y-1];
				db_modify("update tmpkassekl set dato= '$dato[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$dato_ligstart = '';
			$dato_ligslut = '';
		}
# beskrivelse
		if ((!$beskrivelse_ligslut) && ($beskrivelse[$x]=="=>")) {
			$beskrivelse_ligstart=$x;
			$beskrivelse[$x]=$beskrivelse[$x-1];
		}
		if ($beskrivelse[$x]=="<=") {
			$beskrivelse[$x]==$beskrivelse[$x-1];
			if ((!$beskrivelse_ligslut) && ($beskrivelse_ligstart))
				$beskrivelse_ligslut = $x;
		}
		if (($beskrivelse_ligstart)&&($beskrivelse_ligslut)&&($beskrivelse_ligstart<$beskrivelse_ligslut)) {
			for ($y=$beskrivelse_ligstart;$y<=$beskrivelse_ligslut;$y++) {
				$beskrivelse[$y]=$beskrivelse[$y-1];
				db_modify("update tmpkassekl set beskrivelse= '$beskrivelse[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$beskrivelse_ligstart = '';
			$beskrivelse_ligslut = '';
		}
# d_type
		if ((!$d_type_ligslut) && ($d_type[$x]=="=>")) {
			$d_type_ligstart=$x;
			$d_type[$x]=$d_type[$x-1];
		}
		if ($d_type[$x]=="<=") {
			$d_type[$x]==$d_type[$x-1];
			if ((!$d_type_ligslut) && ($d_type_ligstart))
				$d_type_ligslut = $x;
		}
		if (($d_type_ligstart)&&($d_type_ligslut)&&($d_type_ligstart<$d_type_ligslut)) {
			for ($y=$d_type_ligstart;$y<=$d_type_ligslut;$y++) {
				$d_type[$y]=$d_type[$y-1];
				db_modify("update tmpkassekl set d_type= '$d_type[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$d_type_ligstart = '';
			$d_type_ligslut = '';
		}
		if ($d_type[$x] && $d_type[$x] != 'D' && $d_type[$x] != 'K')
			$d_type[$x] = 'F'; #20110605
# debet
		if ((!$debet_ligslut) && ($debet[$x]=="=>")) {
			$debet_ligstart=$x;
			$debet[$x]=$debet[$x-1];
		}
		if ($debet[$x]=="<=") {
			$debet[$x]==$debet[$x-1];
			if ((!$debet_ligslut) && ($debet_ligstart))
				$debet_ligslut = $x;
		}
		if (($debet_ligstart)&&($debet_ligslut)&&($debet_ligstart<$debet_ligslut)) {
			for ($y=$debet_ligstart;$y<=$debet_ligslut;$y++) {
				$debet[$y]=$debet[$y-1];
				db_modify("update tmpkassekl set debet= '$debet[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$debet_ligstart = '';
			$debet_ligslut = '';
		}
# k_type
		if ((!$k_type_ligslut) && ($k_type[$x]=="=>")) {
			$k_type_ligstart=$x;
			$k_type[$x]=$k_type[$x-1];
		}
		if ($k_type[$x]=="<=") {
			$k_type[$x]==$k_type[$x-1];
			if ((!$k_type_ligslut) && ($k_type_ligstart))
				$k_type_ligslut = $x;
		}
		if (($k_type_ligstart)&&($k_type_ligslut)&&($k_type_ligstart<$k_type_ligslut)) {
			for ($y=$k_type_ligstart;$y<=$k_type_ligslut;$y++) {
				$k_type[$y]=$k_type[$y-1];
				db_modify("update tmpkassekl set k_type= '$k_type[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$k_type_ligstart = '';
			$k_type_ligslut = '';
		}
		if ($k_type[$x] && $k_type[$x] != 'D' && $k_type[$x] != 'K')
			$k_type[$x] = 'F'; #20110605
# kredit
		if ((!$kredit_ligslut) && ($kredit[$x]=="=>")) {
			$kredit_ligstart=$x;
			$kredit[$x]=$kredit[$x-1];
		}
		if ($kredit[$x]=="<=") {
			$kredit[$x]==$kredit[$x-1];
			if ((!$kredit_ligslut) && ($kredit_ligstart))
				$kredit_ligslut = $x;
		}
		if (($kredit_ligstart)&&($kredit_ligslut)&&($kredit_ligstart<$kredit_ligslut)) {
			for ($y=$kredit_ligstart;$y<=$kredit_ligslut;$y++) {
				$kredit[$y]=$kredit[$y-1];
				db_modify("update tmpkassekl set kredit= '$kredit[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$kredit_ligstart = '';
			$kredit_ligslut = '';
		}
# kredit
		if ((!$kredit_ligslut) && ($kredit[$x]=="=>")) {
			$kredit_ligstart=$x;
			$kredit[$x]=$kredit[$x-1];
		}
		if ($kredit[$x]=="<=") {
			$kredit[$x]==$kredit[$x-1];
			if ((!$kredit_ligslut) && ($kredit_ligstart))
				$kredit_ligslut = $x;
		}
		if (($kredit_ligstart)&&($kredit_ligslut)&&($kredit_ligstart<$kredit_ligslut)) {
			for ($y=$kredit_ligstart;$y<=$kredit_ligslut;$y++) {
				$kredit[$y]=$kredit[$y-1];
				db_modify("update tmpkassekl set kredit= '$kredit[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$kredit_ligstart = '';
			$kredit_ligslut = '';
		}
# faktura
		if ((!$faktura_ligslut) && ($faktura[$x]=="=>")) {
			$faktura_ligstart=$x;
			$faktura[$x]=$faktura[$x-1];
		}
		if ($faktura[$x]=="<=") {
			$faktura[$x]==$faktura[$x-1];
			if ((!$faktura_ligslut) && ($faktura_ligstart))
				$faktura_ligslut = $x;
		}
		if (($faktura_ligstart)&&($faktura_ligslut)&&($faktura_ligstart<$faktura_ligslut)) {
			for ($y=$faktura_ligstart;$y<=$faktura_ligslut;$y++) {
				$faktura[$y]=$faktura[$y-1];
				db_modify("update tmpkassekl set faktura= '$faktura[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$faktura_ligstart = '';
			$faktura_ligslut = '';
		}
# belob
		if ((!$belob_ligslut) && ($belob[$x]=="=>")) {
			$belob_ligstart=$x;
			$belob[$x]=$belob[$x-1];
		}
		if ($belob[$x]=="<=") {
			$belob[$x]==$belob[$x-1];
			if ((!$belob_ligslut) && ($belob_ligstart))
				$belob_ligslut = $x;
		}
		if (($belob_ligstart)&&($belob_ligslut)&&($belob_ligstart<$belob_ligslut)) {
			for ($y=$belob_ligstart;$y<=$belob_ligslut;$y++) {
				$belob[$y]=$belob[$y-1];
				db_modify("update tmpkassekl set belob= '$belob[$y]' where lobenr='$y' and kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__);
			}
			$belob_ligstart = '';
			$belob_ligslut = '';
		}
/*
		if (strtoupper($debet[$x]) == 'D') $d_type[$x]='D';
		if (strtoupper($debet[$x]) == 'K') $d_type[$x]='K';
		if (strtoupper($kredit[$x]) == 'D') $k_type[$x]='D';
		if (strtoupper($kredit[$x]) == 'K') $k_type[$x]='K';
*/
		# Hvis der skrives d eller k i debet eller kredit felt, slås op kreditor eller debitor liste.
	if ($submit == 'save' && ($fokus=="debe$x" && (strtoupper($debet[$x])=='D' || strtoupper($debet[$x])=='K'))) {
			$qtxt = "select * from kontoplan where genvej='" . strtoupper($debet[$x]) . "' and regnskabsaar='$regnaar'";
			if (!db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				$d_type[$x]=strtoupper($debet[$x]);
				$submit = 'lookup';
				$debet[$x]='';
			}
		} elseif ($submit == 'save' && ($fokus=="kred$x" && (strtoupper($kredit[$x])=='D' || strtoupper($kredit[$x])=='K'))) {
			$qtxt = "select * from kontoplan where genvej='" . strtoupper($kredit[$x]) . "' and regnskabsaar='$regnaar'";
			if (!db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				$k_type[$x]=strtoupper($kredit[$x]);
				$submit = 'lookup';
				$kredit[$x]='';
			}
		}
		if (!isset($id[$x]))
			$id[$x] = NULL;
		if (!isset($id[$x - 1]))
			$id[$x - 1] = NULL;
		if (
			$x >1 && $id[$x] && !$debet[$x] && !$kredit[$x]
		&& $bilag[$x] == $bilag[$x-1] 
		&& $dato[$x] == $dato[$x-1]
			&& $beskrivelse[$x] == $beskrivelse[$x - 1]
		) { #20210920
			$bilag[$x] = '-';
		}
		if (!$forskellige_datoer && $bilag[$x] && $bilag[$x]!='-' && $bilag[$x]==$bilag[$x-1] && $dato[$x]!=$dato[$x-1] && $bilagssum[$x-1]) {
				$alert3 = findtekst(1581, $sprog_id);
			print "<BODY onload=\"javascript:alert('$alert3 $bilag[$x]')\">";
		}
		if (strpos($bilag[$x], '+') && $kladde_id) {
			list($bilag[$x], $newLines) = explode('+', $bilag[$x]);
			if ($newLines == '=') {
				indsaet_linjer(
					$kladde_id,
					$bilag[$x],
					$dato[$x],
					$beskrivelse[$x],
					$d_type[$x],
					(int) $debet[$x],
					$k_type[$x],
					(int) $kredit[$x],
					$faktura[$x],
					(float) $belob[$x],
					(int) $afd[$x],
					$ansat[$x],
					(int) $projekt[$x],
					$valuta[$x],
					$forfaldsdato[$x],
					(int) $betal_id[$x],
					$momsfri[$x],
					$ansat_id[$x]
				);
			} else {
				$newLines = (int) $newLines;
				for ($nl = 0; $nl < $newLines; $nl++) {
					indsaet_linjer(
						$kladde_id,
						$bilag[$x],
						$dato[$x],
						'',
						'',
						0,
						'',
						0,
						'',
						'',
						(int) $afd[$x],
						$ansat[$x],
						(int) $projekt[$x],
						$valuta[$x],
						'',
						'',
						'',
						$ansat_id[$x]
					);
					if ($nl > 25) {
						alert('Max 25 linjer kan indsættes ad gangen');
						break(1);
					}
				}
			}
		}
		if (($bilag[$x])&&($bilag[$x]!="-")&&($bilag[$x]!="->")&&($bilag[$x]!="<-")&&(!strpos($bilag[$x],'+'))&&(substr($bilag[$x],-1)!='r')&&(!is_numeric($bilag[$x]))) {//20160909 undtaget * til brug for bilagsrenum
			 $alerttxt = findtekst(1582, $sprog_id);
			print "<BODY onload=\"javascript:alert('$alerttxt $bilag[$x])')\">";
			$fejl=1;
		} elseif (($bilag[$x]) && ($bilag[$x] != "-") && ($bilag[$x] != "->") && (substr($bilag[$x], -1) != 'r') && ($bilag[$x] != "<-"))
			$bilag[$x] = $bilag[$x] * 1; //20160909 undtaget * til brug for bilagsrenum
		if ($bilag[$x] == "-") {
			$dato[$x]=$beskrivelse[$x]=$d_type[$x]=$debet[$x]=$k_type[$x]=$kredit[$x]=$faktura[$x]=$belob[$x]=$momsfri[$x]=$afd[$x]=
			$projekt[$x]=$ansat[$x]=$valuta[$x]=$forfaldsdato[$x]=$betal_id[$x]='';
		}
		if (!isset($id[$x]))
			$id[$x] = '0';
		if (!$id[$x])
			$id[$x] = '0';
		if (!$kladde_id) {
			$tidspkt=microtime();
			$row = db_fetch_array(db_select("select MAX(id) AS id from kladdeliste",__FILE__ . " linje " . __LINE__));
			$kladde_id=$row['id']+1;
			$kladdedate=date("Y-m-d");	# OBS I naeste linje indsaettes tidspkt fratrukket 1 sek. Ellers bliver 1. gemning afvist af	"Refresktjek"
			db_modify("insert into kladdeliste (id, kladdenote, kladdedate, bogfort, hvem, oprettet_af, tidspkt) values ('$kladde_id', '$ny_kladdenote', '$kladdedate', '-', '$brugernavn', '$brugernavn', '$tidspkt')",__FILE__ . " linje " . __LINE__);
			$tidspkt=microtime();
		}
		if ($kladde_id) {
			$bilag[$x] = db_escape_string($bilag[$x]);
			$dato[$x] = db_escape_string($dato[$x]);
			#cho __line__." dato[$x] $dato[$x]<br>";
			$beskrivelse[$x] = db_escape_string($beskrivelse[$x]);
			$d_type[$x] = db_escape_string($d_type[$x]);
			$debet[$x] = db_escape_string($debet[$x]);
			$k_type[$x] = db_escape_string($k_type[$x]);
			$kredit[$x] = db_escape_string($kredit[$x]);
			$faktura[$x] = db_escape_string($faktura[$x]);
			$belob[$x] = db_escape_string($belob[$x]);
			$momsfri[$x] = db_escape_string($momsfri[$x]);
			$afd[$x] = db_escape_string($afd[$x]);
			$projekt[$x] = db_escape_string($projekt[$x]);
			$ansat[$x] = db_escape_string($ansat[$x]);
			$valuta[$x] = db_escape_string($valuta[$x]);
			$forfaldsdato[$x] = db_escape_string($forfaldsdato[$x]);
			$qtxt = "insert into tmpkassekl ";
			$qtxt .= "(lobenr,id,bilag,transdate,beskrivelse,d_type,debet,k_type,kredit,faktura,";
			$qtxt .= "amount,momsfri,afd,kladde_id,projekt,ansat,valuta,forfaldsdate,betal_id) ";
			$qtxt .= "values ";
			$qtxt .= "('$x', '$id[$x]', '$bilag[$x]', '$dato[$x]', '$beskrivelse[$x]', '$d_type[$x]', '$debet[$x]', ";
			$qtxt .= "'$k_type[$x]', '$kredit[$x]', '$faktura[$x]', '$belob[$x]', '$momsfri[$x]', '$afd[$x]', ";
			$qtxt .= "'$kladde_id', '$projekt[$x]', '$ansat[$x]', '$valuta[$x]','$forfaldsdato[$x]','$betal_id[$x]')";
			#cho __line__." $qtxt<br>";
			db_modify($qtxt, __FILE__ . " linje " . __LINE__);
		}
		if ($fejl)
			$submit = 'save'; #20210721
	}
	#cho __line__." F $fejl<br>";
	if ($fejl)
		$submit = 'save';
	if ($submit == 'copy2new') {
		include_once("kassekladde_includes/copy2new.php");
		copy2new($kladde_id, $bilagsnr, $ny_dato, $vend_fortegn);
	}
	$fokus=$_POST['fokus'];
	if ($kladde_id) {
		$row = db_fetch_array(db_select("select bogfort,tidspkt from kladdeliste where id=$kladde_id",__FILE__ . " linje " . __LINE__));
		if (!$row['bogfort'] && $tidspkt==$row['tidspkt']) { #Refreshtjek"
			$alert = findtekst(1583, $sprog_id);
			print "<BODY onload=\"javascript:alert('$alert')\">";
		} else {
			$qtxt = "update kladdeliste set hvem = '$brugernavn', tidspkt='$tidspkt'";
			if ($ny_kladdenote) {
				$qtxt.= ", kladdenote = '$ny_kladdenote' ";
			$kladdenote = $ny_kladdenote;
			}
			$qtxt.= " where id = '$kladde_id'";
			db_modify($qtxt,__FILE__ . " linje " . __LINE__);
			if (!$kontonr) {
				$x=0;
				$query = db_select("select kontonr from kontoplan where kontotype != 'H' and kontotype != 'Z' and regnskabsaar=$regnaar",__FILE__ . " linje " . __LINE__);
				while($row = db_fetch_array($query)) {
					$x++;
					$kontonr[$x]=trim($row[kontonr]);
				}
				$acc_ant=$x;
			}
			if ($submit == 'lookup')
				$opslag_id = substr($fokus, 4, strlen($fokus) - 4);
			elseif ($kladde_id) {
				$row =db_fetch_array(db_select("select bogfort from kladdeliste where id = $kladde_id",__FILE__ . " linje " . __LINE__));
				if ($row['bogfort']=='-') {
					for ($x=0;$x<=$antal_ny;$x++) {
						if (!isset($bilag[$x]))
							$bilag[$x] = NULL;
						if (!isset($dato[$x]))
							$dato[$x] = NULL;
						if (!isset($beskrivelse[$x]))
							$beskrivelse[$x] = NULL;
						if (!isset($d_type[$x]))
							$d_type[$x] = NULL;
						if (!isset($debet[$x]))
							$debet[$x] = NULL;
						if (!isset($k_type[$x]))
							$k_type[$x] = NULL;
						if (!isset($kredit[$x]))
							$kredit[$x] = NULL;
						if (!isset($faktura[$x]))
							$faktura[$x] = NULL;
						if (!isset($belob[$x]))
							$belob[$x] = NULL;
						if (!isset($momsfri[$x]))
							$momsfri[$x] = NULL;
						if (!isset($afd[$x]))
							$afd[$x] = NULL;
						if ((!$fejl)&&($x!=$opslag_id)&&(($beskrivelse[$x])||($debet[$x])||($kredit[$x]))) {
							kontroller($id[$x],$bilag[$x],$dato[$x],$beskrivelse[$x],$d_type[$x],$debet[$x],$k_type[$x],$kredit[$x],$faktura[$x],$belob[$x],$momsfri[$x],$kontonr,$kladde_id,$afd[$x],$projekt[$x],$ansat[$x],$valuta[$x],$forfaldsdato[$x],$betal_id[$x],$x);
						} elseif ((!$fejl) && ($x != $opslag_id) && ($bilag[$x] == "-")) {
							kontroller($id[$x],$bilag[$x],$dato[$x],$beskrivelse[$x],$d_type[$x],$debet[$x],$k_type[$x],$kredit[$x],$faktura[$x],$belob[$x],$momsfri[$x],$kontonr,$kladde_id,$afd[$x],$projekt[$x],$ansat[$x],$valuta[$x],$forfaldsdato[$x],$betal_id[$x],$x );
						}
					}
					#cho __line__." $submit $debet[$x] $fokus $x<br>";
					if ($fejl)
						$submit = 'save';
				}
			}
#******************************
#cho __line__." $submit $debet[$x] $fokus $x<br>";
#			if ($submit === 'lookup' || $submit === 'save' ) {
			if ($submit === 'lookup') {
				if (isset($debet[$opslag_id])) {
				if (strtoupper($debet[$opslag_id])=="K") $d_type[$opslag_id]="K";
				elseif (strtoupper($debet[$opslag_id])=="D") $d_type[$opslag_id]="D";
				}
				if (isset($kredit[$opslag_id])) {
				if (strtoupper($kredit[$opslag_id])=="K") $k_type[$opslag_id]="K";
				elseif (strtoupper($kredit[$opslag_id])=="D") $k_type[$opslag_id]="D";
				}
				if (isset($d_type[$opslag_id]) && $d_type[$opslag_id]) $d_type[$opslag_id] = trim(strtoupper($d_type[$opslag_id]));
				if (isset($k_type[$opslag_id]) && $k_type[$opslag_id]) $k_type[$opslag_id] = trim(strtoupper($k_type[$opslag_id]));
				if ((strstr($fokus,"debe"))||(strstr($fokus,"d_ty"))) {
					if ($d_type[$opslag_id] == "K") {
						include('kassekladde_includes/creditorLookup.php');
						creditorLookup($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					} elseif ($d_type[$opslag_id] == "D") {
						include('kassekladde_includes/debitorLookup.php');
						debitorLookup($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					} else {
						include('kassekladde_includes/financeLookup.php');
						financeLookup($find, 'kontonr', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					}
				}
				if ((strstr($fokus,"kred"))||(strstr($fokus,"k_ty"))) {
					if ($k_type[$opslag_id] == "K") {
						include('kassekladde_includes/creditorLookup.php');
						creditorLookup($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					}
					if ($k_type[$opslag_id] == "D") {
						include('kassekladde_includes/debitorLookup.php');
						debitorLookup($find, 'firmanavn', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					} else {
						include('kassekladde_includes/financeLookup.php');
						financeLookup($find, 'kontonr', $fokus, $opslag_id, $id[$opslag_id], $kladde_id, $bilag[$opslag_id], $dato[$opslag_id], $beskrivelse[$opslag_id], $d_type[$opslag_id], $debet[$opslag_id], $k_type[$opslag_id], $kredit[$opslag_id], $faktura[$opslag_id], $belob[$opslag_id], $momsfri[$opslag_id], $afd[$opslag_id], $projekt[$opslag_id], $ansat[$opslag_id], $valuta[$opslag_id], $forfaldsdato[$opslag_id], $betal_id[$opslag_id], $opslag_id);
					}
				}
				if ((strstr($fokus,"fakt"))||(strstr($fokus,"belo"))) {
					include ("kassekladde_includes/openpost_inc.php");
					openpost($find,'firmanavn',$fokus,$opslag_id,$id[$opslag_id],$kladde_id,$bilag[$opslag_id],$dato[$opslag_id],$beskrivelse[$opslag_id],$d_type[$opslag_id],$debet[$opslag_id],$k_type[$opslag_id],$kredit[$opslag_id],$faktura[$opslag_id],$belob[$opslag_id],$momsfri[$opslag_id],$afd[$opslag_id],$projekt[$opslag_id],$ansat[$opslag_id],$valuta[$opslag_id],$forfaldsdato[$opslag_id],$betal_id[$opslag_id],$opslag_id);
				}
				if (strstr($fokus, "afd")) {
					include_once('kassekladde_includes/departmentLookup.php');
					departmentLookup($fokus, $opslag_id, $opslag_id);
				}
				if (strstr($fokus, "meda")) {
					include_once('kassekladde_includes/employeeLookup.php');
					employeeLookup($fokus, $opslag_id, $opslag_id);
				}
				if (strstr($fokus, "proj")) {
					include_once('kassekladde_includes/projectLookup.php');
					projectLookup($fokus, $opslag_id, $opslag_id);
				}
				if (strstr($fokus, "valu")) {
					include_once('kassekladde_includes/currencyLookup.php');
					currencyLookup($fokus, $opslag_id, $opslag_id);
				}
		 	}
			// if (strstr($submit,"Simul")) {
			if ($submit == 'simulate')	{ #20210721
				print "<meta http-equiv='refresh' content='0;URL=../finans/bogfor.php?kladde_id=$kladde_id&funktion=simuler'>";
/*
#				?>
#				<body onload="simuler()">
#				<?php
*/
			}
			#if (strstr($submit,"Bogf"))	{
			if ($submit == 'doPost'){	
				print "<meta http-equiv='refresh' content='0;URL=../finans/bogfor.php?kladde_id=$kladde_id&funktion=bogfor'>";
			}
			#if (strstr($submit,"Tilbagef")){
			if ($submit == 'revert'){	
				tilbagefor($kladde_id);
			}
			if ($submit == 'upload') {
				print "<meta http-equiv='refresh' content='0;URL=../finans/hentordrer.php?kladde_id=$kladde_id'>";
			}
			#if (strstr($submit,"Impor")) {
			if ($submit == 'import')	{
				if (!$bilagsnr) { #20171129
					$r=db_fetch_array(db_select("select max(bilag) as bilagsnr from kassekladde where kladde_id='$kladde_id'",__FILE__ . " linje " . __LINE__));
					$bilagsnr=$r['bilagsnr'];
				}
				print "<meta http-equiv='refresh' content='0;URL=../finans/importer.php?kladde_id=$kladde_id&bilagsnr=$bilagsnr'>";
			}
			#if (strstr($submit,"Udlig")) {
			if ($submit == 'offset')	{
				print "<meta http-equiv='refresh' content='0;URL=../finans/autoudlign.php?kladde_id=$kladde_id'>";
			}
			if (strstr($submit,"DocuB")) {
				print "<meta http-equiv='refresh' content='0;URL=../finans/docubizzimport.php?kladde_id=$kladde_id'>";
			}
		}
	}
} else {# endif ($_POST)
	$qtxt = "select * from grupper where ART = 'bilag' and (box6 ='on' or (box1 !='' and box2 !='' and box3 !=''))";
	($r=db_fetch_array(db_select($qtxt,__FILE__ . " linje " . __LINE__)))?$vis_bilag=1:$vis_bilag=0;
	if (!$r & isset($kladde_id))
		$vis_bilag = 1; //20230806 For the attachment clip to be shown if kladde_id already exits
	(isset($r['box6']) && $r['box6']=='on')?$intern_bilag=1:$intern_bilag=0;
	(db_fetch_array(db_select("select * from grupper where ART = 'AFD'",__FILE__ . " linje " . __LINE__)))?$vis_afd=1:$vis_afd=0;
	(db_fetch_array(db_select("select * from grupper where ART = 'PRJ'",__FILE__ . " linje " . __LINE__)))?$vis_projekt=1:$vis_projekt=0;
	(db_fetch_array(db_select("select * from grupper where ART = 'VK'",__FILE__ . " linje " . __LINE__)))?$vis_valuta=1:$vis_valuta=0;
}
$ansat_id = array();
if ($r=db_fetch_array(db_select("select id from adresser where art = 'S'",__FILE__ . " linje " . __LINE__))) {
	$egen_kto_id = $r['id'];
	$z=0;
	$qtxt = "select id, initialer from ansatte where konto_id = '$egen_kto_id' and lukket != 'on' order by id";
	$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
	while ($r=db_fetch_array($q)) {
		$z++;
		$vis_ansat=1;
		$ansat_id[$z] = 0;
		#cho $r['id'];
		$ansat_id[$z]=$r['id'];
		$ansat_init[$z]=$r['initialer'];
	}
}
if (!$fejl && $kladde_id) {
	opdater($kladde_id);
	db_modify ("delete from tmpkassekl where kladde_id=$kladde_id",__FILE__ . " linje " . __LINE__);
}
/*
if (strlen($kontrolkonto)==1) {
	$kontrolkonto=strtoupper($kontrolkonto);
	$query = db_select("select * from kontoplan where genvej='$kontrolkonto' and regnskabsaar='$regnaar'",__FILE__ . " linje " . __LINE__);
	if ($row = db_fetch_array($query)) $kontrolkonto=$row['kontonr'];
	else {
		$kontrolkonto=' ';
		setcookie("saldi_ktrkto",$kontrolkonto,time()+0);
	}
}
if (strlen($kontrolkonto)>1) setcookie("saldi_ktrkto",$kontrolkonto,time()+60*60*24*30);
else setcookie("saldi_ktrkto",$kontrolkonto,time()-3600);
ob_end_flush();	//Sender det "bufferede" output afsted...
*/
		if ($kladde_id) {
	$query = db_select("select kladdenote, bogfort from kladdeliste where id = $kladde_id",__FILE__ . " linje " . __LINE__);
	$row = db_fetch_array($query);
	$kladdenote = htmlentities(stripslashes($row['kladdenote']),ENT_QUOTES,$charset);
	$bogfort = $row['bogfort'];
}
$x=0;
($visipop)?$ny=NULL:$ny= findtekst(39, $sprog_id); #20210628
if (!$simuler) {
	if ($returside != "regnskab") {
		$returside = "../finans/kladdeliste.php";
	}
	($udskriv)?$height='':$height='height="100%"';
	if ($menu != 'T') {
		print "<table width='100%' $height border='0' cellspacing='1' cellpadding='0'><tbody>"; # Tabel 1 -> Hovedramme
	}
	if (!$udskriv) {
		if ($menu=='T') {
			include_once '../includes/top_header.php';
			include_once '../includes/top_menu.php';

			$tekst = findtekst(154, $sprog_id);
			print "<div id='header'>";
			print "<div class='headerbtnLft headLink'><a href=\"javascript:confirmClose('../finans/kladdeliste.php?exitDraft=$kladde_id','$tekst')\" accesskey=L title='Klik her for at komme tilbage'><i class='fa fa-close fa-lg'></i> &nbsp;" . findtekst(30, $sprog_id) . "</a></div>";
			print "<div class='headerTxt'>$title &nbsp;•&nbsp; $kladde_id</div>";
			print "<div class='headerbtnRght headLink'><a accesskey=N href=\"javascript:confirmClose('../finans/kassekladde.php?exitDraft=$kladde_id','$tekst')\"' title='TEXTHERE'><i class='fa fa-plus-square fa-lg'></i></a></div>";
			print "</div>";
			print "<div class='content-noside'>";
#		} elseif ($menu == 'S') {
#			print "<table width='100%' height='100%' border='0' cellspacing='2' cellpadding='0'><tbody>";
#			print "<tr><td style = 'width:150px;'>";
#			include ('../includes/sidebar.html');
#			print "</td><td><table cellpadding='1' cellspacing='1' border='0' width='100%' valign = 'top'>";
		} else {
/*
			if (($menu == 'S')) {
				print "<table width='100%' height='100%' border='0' cellspacing='2' cellpadding='0'><tbody>";
				print "<tr><td style = 'width:150px;'>";
				include ('../includes/sidebar.html');
			}
*/
			print "<tr><td height='1%' align='center' valign='top'>";
			print "<table width='100%' align='center' border='0' cellspacing='2' cellpadding='0'><tbody><tr>"; # Tabel 1.1 -> Toplinje
			if ($popup) print "<td onclick='JavaScript:opener.location.reload();' width='10%' $top_bund>";
			else print "<td $top_bund>";
			$tekst=findtekst(154,$sprog_id);
			if ($popup || $visipop) {
				print "<a href=\"javascript:confirmClose('../includes/luk.php?tabel=kladdeliste&amp;id=$kladde_id&exitDraft=$kladde_id','$tekst')\" accesskey='L'>" . findtekst(30, $sprog_id) . "</a></td>";
			} else {
				print "<a href=\"javascript:confirmClose('../finans/kladdeliste.php?exitDraft=$kladde_id','$tekst')\" accesskey='L'>" . findtekst(30, $sprog_id) . "</a></td>";
			}
			print "<td width='80%' $top_bund> " . findtekst(1072, $sprog_id) . "  $kladde_id</td>";
			print "<td width='10%' $top_bund align='right'><a href=\"javascript:confirmClose('../finans/kassekladde.php?exitDraft=$kladde_id','$tekst')\" accesskey='N'>$ny</a></td></tr>";
		}
		print "</tbody></table>";# Tabel 1.1 <- Toplinje
		print "</td></tr>\n";
	}
}
if (!$udskriv) {
	print "<form name='kassekladde' id='kassekladde' action='../finans/kassekladde.php?kksort=$kksort' method='post'>";
	print "<input type='hidden' name='kladde_id' value='$kladde_id'>";
	print "<input type='hidden' name='kladdenote' value='$kladdenote'>";

	print "<tr><td width='100%' valign='top' height='1%\ align='center'>
		<table width='100%' cellpadding='0' cellspacing='0' border='0' align = 'center' valign = 'top'>";
	print "<tbody>"; # Tabel 1.2 -> bemærkningstekst
	print "<tr>";
	print "<td width = '14%'></td>";
	print "<td align='left'><b><span title= '" . findtekst(1559, $sprog_id) . "'>" . findtekst(599, $sprog_id) . ":</b>
	<input class='inputbox' type='text' style='width:750px' name=ny_kladdenote value='$kladdenote'
	onchange='javascript:docChange = true;'></td>";
	if ($bogfort=="-") {
		if (!isset($kontrolkonto) && isset($_COOKIE['saldi_ktrkto'])) $kontrolkonto = $_COOKIE['saldi_ktrkto'];
		if ($kontrolkonto == "-") $kontrolkonto = "";
		print "<td></td><td><span title= '" . findtekst(1560, $sprog_id) . "'><input class='inputbox' type='text' style='text-align:right;width:80px' name='kontrolkonto' value='$kontrolkonto' placeholder = 'kontrolkonto' onchange='javascript:docChange = true;'></td>";
#	} elseif ($bogfort!="S") {
	} else {	
		print "<td></td><td width='80px' align='center'><span title='" . findtekst(1561, $sprog_id) . "'><input type='submit' class='button gray small' style='width:120px;float:left' accesskey='o' value='" . findtekst(1091, $sprog_id) . "' name='updateNote' onclick='javascript:docChange = false;'></span></td>";
	}
	print "<td></td><td width = '7%' align='center'>
		<a href='../finans/kassekladde.php?kladde_id=$kladde_id&udskriv=1' target='blank'>
		<img src='../ikoner/print.png' style='border: 0px solid;'></a></td>
		<td width = '7%' align = 'center'><a href = https://saldi.dk/dok/ledgerGuide.pdf target = '_blank'>?</a></td></tr>\n";
	#print "</tr><tr><td><br color='$bgcolor5' 'align='center''></td></tr>\n";
	print "</tbody></table>";# Tabel 1.2 <- bemærkningstekst
	#}
	# ####################################################################################################
}
if ($udskriv)
	print "<tr><td style='width:100%;'>";
else
	print "<tr><td style='height:100%;width:100%;'>";
if (($bogfort && $bogfort != '-') || $udskriv) {
	if ($menu == 'T') {
		print "<br><center><table class='dataTable' width='100%' cellpadding='1' cellspacing='3' border='0' align = 'center' valign = 'top'>";
	} else {
		print "<table cellpadding='1' cellspacing='3' border='0' align = 'center' valign = 'top'>";
	}
}
#elseif ($browser=="opera" || $browser=="firefox") print "<table cellpadding='0' cellspacing='0' border='0' align = 'center' valign = 'top'>";
else
	print "<center><table cellpadding='0' cellspacing='0' border='0' align = 'center' class='formnavi dataTableForm'>";
print "<tbody>"; # Tabel 1.3 -> kladdelinjer
print "<tr>";
if ($vis_bilag && !$fejl && !$udskriv)
	print "<td></td>";
print "<td align = center><b><span title= '".findtekst(1562, $sprog_id)."'><a href=../finans/kassekladde.php?kladde_id=$kladde_id&kksort=bilag,transdate&tjek=$kladde_id>".findtekst(671,$sprog_id)."</a></b></td>";
print "<td align = center><b> <span title= '".findtekst(1563, $sprog_id)."'><a href=../finans/kassekladde.php?kladde_id=$kladde_id&kksort=transdate,bilag&tjek=$kladde_id>".findtekst(635,$sprog_id)."</a></b></td>";
print "<td align = center><b> ".findtekst(1068,$sprog_id)."</b></td>";
print "<td align = center><b> <span title= '".findtekst(1564, $sprog_id)."'>D/K</b></td>";
print "<td align = center><b> <span title= '".findtekst(1565, $sprog_id)."'>".ucfirst(findtekst(1000,$sprog_id))."</b></td>";
print "<td align = center><b> <span title= '".findtekst(1564, $sprog_id)."'>D/K</b></td>";
print "<td align = center><b> <span title= '".findtekst(1565, $sprog_id)."'>".ucfirst(findtekst(1001,$sprog_id))."</b></td>";
print "<td align = center><b> <span title= '".findtekst(1566, $sprog_id).".'>".findtekst(828,$sprog_id).".</b></td>";
print "<td align = center><b> <span title= '".findtekst(1543, $sprog_id)."'><a href=../finans/kassekladde.php?kladde_id=$kladde_id&kksort=amount&tjek=$kladde_id>".findtekst(934,$sprog_id)."</a></b></td>"; #20210720
if ($vis_afd)
	print "<td align = left><b> <span title= '" . findtekst(1567, $sprog_id) . "'>Afd.</b></td>";
if ($vis_ansat)
	print "<td align = left><b> <span title= '" . findtekst(1568, $sprog_id) . "'>" . findtekst(589, $sprog_id) . ".</b></td>";
if ($vis_projekt)
	print "<td align = left><b> <span title= '" . findtekst(1569, $sprog_id) . "'>Proj.</b></td>";
if ($vis_valuta)
	print "<td align = left><b> <span title= '" . findtekst(1570, $sprog_id) . "'>" . findtekst(1069, $sprog_id) . "</b></td>";
if (db_fetch_array(db_select("select id from kassekladde where kladde_id = '$kladde_id' and (k_type = 'K' or d_type = 'D')",__FILE__ . " linje " . __LINE__))) {
	print "<td  align='center'><b> <span title= '" . findtekst(1571, $sprog_id) . "'>" . findtekst(1070, $sprog_id) . "</b></td>";
	if ($vis_bet_id)
		print "<td  align='center'><b> <span title= '" . findtekst(1572, $sprog_id) . "'>" . findtekst(1071, $sprog_id) . ".id</b></td>";
}
print "<td align='center' width='30px'><b> <span title= '" . findtekst(1573, $sprog_id) . "'>&nbsp;u/m&nbsp;</b></td>";
if ($kontrolkonto) {
	print "<td align='center' width='30px'><b> <span title= '" . findtekst(1573, $sprog_id) . "'>Saldo<br>Regnskab</b></td>";
	$qtxt = "select id from kassekladde where saldo != 0 and kladde_id = '$kladde_id'";
	if (db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
		print "<td style = 'width:20px'></td>";
		print "<td align='center' width='30px'><b> <span title= '" . findtekst(1573, $sprog_id) . "'>Saldo<br>Bank</b></td>";
}
}
#print "<td align='right' width='30px'><b> <span title= 'Afm&aelig;rk her, hvis der ikke skal tr&aelig;kkes moms'>&nbsp;u/m</b></td>";
print "</tr>\n";

#####################################  Output  #################################

$r=db_fetch_array(db_select("select * from grupper where ART = 'KASKL' and kode='1' and kodenr='$bruger_id'",__FILE__ . " linje " . __LINE__));
if ($r)
$kksort=$r['box1'];
if ($r) $kontrolkonto = $r['box2'];
if ($kladde_id) {
	if ($kksort != 'transdate,bilag' && $kksort != 'amount')
		$kksort = 'bilag,transdate';
	$id = array();
	$bilag = array();
	$dato = array();
	$beskrivelse = array();
	$d_type = array();
	$debet = array();
	$k_type = array();
	$kredit = array();
	$faktura = array();
	$belob = array();
	$afd = array();
	$ansat = array();
	$ansat_id = array();
	$projekt = array();
	$valuta = array();
	$forfaldsdato = array();
	$betal_id = array();
	$momsfri = array();
	if ($popup)
		print "<meta http-equiv='refresh' content='3600;URL=../includes/luk.php?tabel=kladdeliste&id=$kladde_id'>";
	else
		print "<meta http-equiv='refresh' content='3600;URL=../finans/kladdeliste.php?tabel=kladdeliste&id=$kladde_id'>";
	$qtxt = "select * from tmpkassekl where kladde_id = $kladde_id order by lobenr";
	$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
	if ($row = db_fetch_array($query)) {
		$qtxt = "select * from tmpkassekl where kladde_id = $kladde_id order by lobenr";
		$fejl=1;
	} else {
		$qtxt = "select * from kassekladde where kladde_id = $kladde_id order by $kksort, id";
	}
	#cho __line__." $qtxt<br>";
	$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
	$bilagssum=0;
	#cho __line__." $qtxt<br>";
	while ($row = db_fetch_array($q)) {
		$x++;
		$id[$x]=$row['id'];
		$bilag[$x]=$row['bilag'];
		$forfaldsdato[$x]=NULL;
		if ($fejl) {
			$transdate[$x] = $row['transdate'];
			$dato[$x] = dkdato($row['transdate']);
			#cho __line__." transdate[$x] $transdate[$x] | dato[$x] $dato[$x]<br>";
			if ($row['forfaldsdate']) {
				$forfaldsdate[$x]=usdate($row['forfaldsdate']);
				$forfaldsdato[$x]=$row['forfaldsdate'];
			}
		}	else {
			$transdate[$x]=$row['transdate'];
			$dato[$x]=dkdato($row['transdate']);
			#cho __line__." transdate[$x] $transdate[$x] | dato[$x] $dato[$x]<br>";
			if ($row['forfaldsdate']) {
				$forfaldsdate[$x]=$row['forfaldsdate'];
				$forfaldsdato[$x]=dkdato($row['forfaldsdate']);
			}
		}
#		$beskrivelse[$x]=htmlentities($row['beskrivelse'],ENT_QUOTES,$charset);
		$beskrivelse[$x]=$row['beskrivelse'];
		while (strpos($beskrivelse[$x], "''"))
			$beskrivelse[$x] = str_replace("''", "'", $beskrivelse[$x]); #20130731
		$beskrivelse[$x]=htmlentities($beskrivelse[$x],ENT_QUOTES,$charset);
		$dokument[$x]=$row['dokument']; # ligger allerede med htmlentities i tabellen;
		$d_type[$x]=trim($row['d_type']);
		$debet[$x]=$row['debet'];
		$debettext[$x]=NULL;
		$k_type[$x]=$row['k_type'];
		if ($k_type[$x] == "K" || $d_type[$x] == "D")
			$vis_forfald = 1;
		$kredit[$x]=$row['kredit'];
		$kredittext[$x]=NULL;
		$faktura[$x]=htmlentities($row['faktura'],ENT_QUOTES,$charset);
		$saldo[$x] = $row['saldo'];
		$amount[$x]=$row['amount'];
		if ($fejl) {
			#			$belob[$x]=$amount[$x];
#			$amount[$x]=usdecimal($amount[$x],2);
		} #else $belob[$x]=dkdecimal($amount[$x],2);
		$momsfri[$x]=$row['momsfri'];
		$afd[$x]=$row['afd'];
		if ($fejl)
			$ansat[$x] = $row['ansat'];
		else
			$ansat_id[$x] = $row['ansat'];
		if (!$fejl && $ansat_id[$x]) {
			$r2 = db_fetch_array(db_select("select navn, initialer from ansatte where id='$ansat_id[$x]'",__FILE__ . " linje " . __LINE__));
			$ansat[$x]=$r2['initialer'];
			$ansat_navn[$x]=$r2['navn'];
		} elseif (!$fejl)
			$ansat[$x] = '';
		($row['projekt'])?$projekt[$x]=$row['projekt']:$projekt[$x]='';
			$valutakode[$x]=$row['valuta']*1;
			if ($valutakode[$x]) {
			$qtxt = "select box1 from grupper where art='VK' and kodenr ='$valutakode[$x]'";
			$r2 = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
				$valuta[$x]=$r2['box1'];
			}
		if (!isset($valuta[$x]) || $valuta[$x] == 'DKK') $dkkamount[$x] = $amount[$x]; #20240419
		elseif ($valutakode[$x]) {
			list($dkkamount[$x], $diffkonto[$x], $valutakurs[$x]) = valutaopslag($amount[$x], $valutakode[$x], $transdate[$x]);
		} else $dkkamount[$x] = (float) $amount[$x];
		if (!$beskrivelse) $beskrivelse = '';
		if (($d_type[$x]=='F')&&($debet[$x])&&(!$fejl)) {
			$query2 = db_select("select beskrivelse, moms from kontoplan where kontonr='$debet[$x]' and regnskabsaar='$regnaar'",__FILE__ . " linje " . __LINE__);
			if ($row2 = db_fetch_array($query2)) {
			$debettext[$x]=$row2['beskrivelse'];
				if (trim($row2['moms']))
					$debettext[$x] = $debettext[$x] . "&nbsp;-&nbsp;" . trim($row2['moms']);
			} else
				$debettext[$x] = '';
		}
		if ((($d_type[$x]=='D')||($d_type[$x]=='K'))&&($debet[$x])&&(!$fejl)) {
			$query2 = db_select("select firmanavn,betalingsbet,betalingsdage from adresser where kontonr='$debet[$x]' and art = '$d_type[$x]'",__FILE__ . " linje " . __LINE__);
			if ($row2 = db_fetch_array($query2)) {
			$debettext[$x]=trim($row2['firmanavn']);
			$tmpffdato=forfaldsdag($transdate[$x],$row2['betalingsbet'],$row2['betalingsdage']);
			} else
				$debettext[$x] = '';
		}
		if (($k_type[$x]=='F')&&($kredit[$x])&&(!$fejl)) {
			$query2 = db_select("select beskrivelse, moms from kontoplan where kontonr='$kredit[$x]' and regnskabsaar='$regnaar'",__FILE__ . " linje " . __LINE__);
			if ($row2 = db_fetch_array($query2)) {
			$kredittext[$x]=trim($row2['beskrivelse']);
				if (trim($row2['moms']))
					$kredittext[$x] = $kredittext[$x] . "&nbsp;-&nbsp;" . trim($row2['moms']);
			} else
				$kredittext[$x] = '';
		}
		if ((($k_type[$x]=='D')||($k_type[$x]=='K'))&&($kredit[$x])&&(!$fejl)) {
			$query2 = db_select("select firmanavn,betalingsbet,betalingsdage from adresser where kontonr='$kredit[$x]' and art = '$k_type[$x]'",__FILE__ . " linje " . __LINE__);
			if ($row2 = db_fetch_array($query2))
				$kredittext[$x] = trim($row2['firmanavn']);
			else
				$kredittext[$x] = '';
			$tmpffdato=forfaldsdag($transdate[$x],$row2['betalingsbet'],$row2['betalingsdage']);
		}
		if (!isset($gl_transdate[$x]))
			$gl_transdate[$x] = NULL;
		if ((($d_type[$x]=='D'&& $debet[$x])||($k_type[$x]=='K'&& $kredit[$x])) && !$fejl && $gl_transdate[$x] && (!$forfaldsdato[$x] || $gl_transdate[$x] != $transdate[$x])) { #20140624
			$forfaldsdato[$x]=$tmpffdato;
		}
		$betal_id[$x]=$row['betal_id'];
	}
	if (!$fejl)
		db_modify("delete from tmpkassekl where kladde_id=$kladde_id", __FILE__ . " linje " . __LINE__);
}
for ($y=1;$y<=$x;$y++)
	if (!$fejl)
		$antal_ex = $x;
if (($bogfort && $bogfort!='-') || $udskriv) {
	for ($y=1;$y<=$x;$y++) {
		if (!$beskrivelse[$y])
			$beskrivelse[$y] = "&nbsp;";
#		if (($d_type[$y]!="D")&&($d_type[$y]!="K")) $d_type[$y]="F"; #phr 20070801
		if ($debet[$y] < 1){
			$debet[$y]="&nbsp;";
			$d_type[$y]="&nbsp;"; #phr 20070801
		}
#		if (($k_type[$y]!="D")&&($k_type[$y]!="K")) $k_type[$y]="F"; #phr 20070801
		if ($kredit[$y] < 1){
			$kredit[$y]="&nbsp;";
			$k_type[$y]="&nbsp;"; #phr 20070801
		}
		if (!$faktura[$y])
			$faktura[$y] = "&nbsp;";
		($linjebg!=$bgcolor)?$linjebg=$bgcolor:$linjebg=$bgcolor5;
		print "<tr bgcolor=$linjebg>";
		if ($vis_bilag && !$fejl && !$udskriv && isset($id[$y])) {
			$qtxt = "select id from documents where source = 'kassekladde' and source_id = '$id[$y]'";  //20230630
			if ($dokument[$y] || db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				$clip = 'paper.png';
				$titletxt =  findtekst(1454, $sprog_id);
			} else {
				$clip = 'clip.png';
				$titletxt =  findtekst(1455, $sprog_id);
			}
			$href = "../includes/documents.php?source=kassekladde&&ny=ja&sourceId=$id[$y]&kladde_id=$kladde_id&bilag=$bilag[$y]&dokument=$dokument[$y]&bilag_id=$id[$y]&fokus=bila$y";
			print "<td title='$titletxt'><!-- ". __line__ ." -->";
			print "<a onClick='this.form.submit()' href='$href'><img src='../ikoner/$clip' style='width:20px;height:20px;'></a></td>\n";
		}
		print "<td> $bilag[$y]</td>";
		print "<td> $dato[$y]</td>";
		print "<td> $beskrivelse[$y]</td>";
		print "<td> $d_type[$y]</td>";
		print "<td align=right title='$debettext[$y]'>$debet[$y]</td>";
		print "<td> $k_type[$y]</td>";
		print "<td align=right title='$kredittext[$y]'>$kredit[$y]</td>";
		print "<td align=right>$faktura[$y]</td>";
		print "<td align=right>". dkdecimal($amount[$y]) ."</td>";
		if ($vis_afd)
			print "<td align=right> $afd[$y]</td>";
		if ($vis_ansat)
			print "<td align=right>$ansat[$y]</td>";
		if ($vis_projekt)
			print "<td align=right>$projekt[$y]</td>";
		if ($vis_valuta)
			print "<td align=right>$valuta[$y]</td>";
		if ($forfaldsdato[$y]) {
			print "<td>$forfaldsdato[$y]</td>";
			if ($vis_bet_id)
				print "<td>$betal_id[$y]</td>";
		} elseif ($vis_forfald) {
			print "<td><br></td>";
			if ($vis_bet_id)
				print "<td><br></td>";
		}
		if (strstr($momsfri[$y], "on")) {
			print "<td align='center'> V</td>";
		} else {
			print "<td> <br></td>";
		}
		if (!$udskriv && $bogfort != 'S')
			print "<td title='" . findtekst(1574, $sprog_id) . "'><a href='../finans/kassekladde.php?kladde_id=$kladde_id&ompost=$id[$y]'><img alt='undo' src='../ikoner/undo.png' style='border: 0px solid ; width: 18px; height: 17px;'></a></td>";
		print "</tr>\n";
	}
	print "<tr><td><br></td></tr>";
} else { ################################ Kladden er ikke bogfort ########################################

	$debetsum = $kontrolmoms = $kontrolsaldo = $kreditsum = 0;
	include_once("../includes/stdFunc/fiscalYear.php");
	list($regnstart, $regnslut) = explode(":", fiscalYear($regnaar));

	if ($menu == 'T') {
		$de_fok = "";
	} else {
	$de_fok="onfocus=\"fokuser(this,'#000000','#EFEFEF');\" onblur=\"defokuser(this,'#000000','#FFFFFF');\"";
	}
	if ($kontrolkonto) {
		$control_next_date = '9999-12-31';
		$kontrolkonto=$kontrolkonto*1;
		$qtxt = "select saldo,moms from kontoplan where kontonr='$kontrolkonto' and regnskabsaar='$regnaar'";
#		$qtxt = "select primo,moms from kontoplan where kontonr='$kontrolkonto' and regnskabsaar='$regnaar'";
		if ($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
			$kontrolsaldo=$r['saldo'];
#			$kontrolsaldo = $r['primo'];
			if ($r['moms']) {
				$r2 = db_fetch_array(db_select("select box2 from grupper where
						kode='".substr($r[moms],0,1)."' and
						kodenr='".substr($r[moms],1,1)."'",__FILE__ . " linje " . __LINE__));
				$kontrolmoms=$r['box2']*1;
			}
		}
/*
		$q = db_select("select transdate from transaktioner where kontonr='$kontrolkonto' order by transdate desc limit 1", __FILE__ . " linje " . __LINE__);
		if ($r = db_fetch_array($q)) {
			$control_bal_last = $r['transdate'];
		} else {
			$control_bal_last = "1970-01-01";
		}
*/
	}
	if (!isset($bilag[0]))
		$bilag[0] = 0;
	if (!isset($bilag[$x + 1]))
		$bilag[$x + 1] = 0;
	if (!isset($dato[0]))
		$dato[0] = NULL;
	if (!isset($dato[$x + 1]))
		$dato[$x + 1] = NULL;
	for ($y=1;$y<=$x;$y++) {
		if (!isset($bilag[$y]))
			$bilag[$y] = 0;
		if (!isset($dato[$y]))
			$dato[$y] = NULL;
		if (!isset($kredit[$y]))
			$kredit[$y] = NULL;
		if (!isset($debet[$y]))
			$debet[$y] = NULL;
		if (!isset($kredittext[$y]))
			$kredittext[$y] = NULL;
		if (!isset($debettext[$y]))
			$debettext[$y] = NULL;
		$amount[$y] = (float) $amount[$y];
		if ((!$fejl)&&((($bilag[$y])=="-")||(!$bilag[$y])&&(!$dato[$y]))) {
			$bilag[$y] = $dato[$y] = $beskrivelse[$y] = $d_type[$y] = $debet[$y] = $k_type[$y] = $kredit[$y] = $faktura[$y] = '';
			$belob[$y] = $momsfri[$y] = '';
			$afd[$y] = '';
			$projekt[$y] = '';
			$valuta[$y] = '';
			$forfaldsdato[$y] = '';
			$betal_id[$y] = '';
		}
		if ($fejl && !$dato[$y] && !$beskrivelse[$y] && !$debet[$y] && !$kredit[$y] && !$faktura[$y] && !$belob[$y])
			$bilag[$y] = '';
		if (!$fejl && $debet[$y] < 1)
			$debet[$y] = "";
		if (!$fejl && $kredit[$y] < 1)
			$kredit[$y] = "";
		if ($fejl)
#			$amount[$y] = usdecimal($amount[$y], 2); # phr 20070801
		if (!$debet[$y])
			$debet[$y] = "";
		if (!$kredit[$y])
			$kredit[$y] = "";
#		if($valuta[$y]&&$valuta[$y]!='DKK') {
#		if ($r=db_fetch_array(db_select("select kodenr from grupper where art='VK' and box1='$valuta[$y]'",__FILE__ . " linje " . __LINE__))) {
#			if ($r=db_fetch_array(db_select("select kurs from valuta where gruppe='$r[kodenr]' and valdate < '$transdate[$y]' order by valdate desc",__FILE__ . " linje " . __LINE__))) {
#				$dk_amount=$amount[$y]*$r['kurs']/100;
#				} else $dk_amount=0;
#			} else $dk_amount=$amount[$y];
#		} else $dk_amount=$amount[$y];
		if ($momsfri[$y] || !$kontrolmoms)
			$tmp = 1;
		else
			$tmp = (100 + $kontrolmoms) / 100;

		if ($kontrolkonto) {
/*
			$pre = ($y-1);
			if ($y == 1) {
				$qtxt = "select sum(debet - kredit) as amount from transaktioner where ";
				$qtxt.= "kontonr = '$kontrolkonto' and transdate >= '$regnstart' and transdate <= '$transdate[$y]'";
				if ($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) $kontrolkonto+=$r['amount'];
			} elseif ($transdate[$y] != $transdate[$pre]) {
				$qtxt = "select sum(debet - kredit) as amount from transaktioner where ";
				$qtxt.= "kontonr = '$kontrolkonto' and transdate > '$transdate[$pre]' and transdate <= '$transdate[$y]'";
				if ($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) $kontrolkonto+=$r['amount'];
			}
*/
/*
			include_once("kassekladde_includes/datebalance_inc.php");
			include_once("kassekladde_includes/transdate_inc.php");
			$date_to = usdate($dato[$y]);
			if ($y === 1) {
				$date_from = usdate($dato[$y]);
				$date_previous = $date_from;
				$control_next_date = transdate($kontrolkonto, $date_to, 'next');
				$control_record_date = transdate($kontrolkonto, $date_to, 'prev');
			} else {
				$date_previous = usdate($dato[$y - 1]);
				if (!($date_to === $date_from)) {
					$date_to = usdate($dato[$y]);
					if (preg_replace('/\D/', '', $date_to) >= preg_replace('/\D/', '', $control_next_date)) {
						$q2 = db_select("select transdate from transaktioner where transdate<='$date_to' and transdate>'$date_from' and kontonr='$kontrolkonto'", __FILE__ . " linje " . __LINE__);
						if ($r2 = db_fetch_array($q2)) {
							$control_bal_fetched = TRUE;
							$control_bal_latest = $date_to;
							$kontrolsaldo = datebalance($kontrolkonto, $regnaar, $date_to);
							$date_from = usdate($dato[$y]);
							$control_next_date = transdate($kontrolkonto, $date_to, 'next');
							$control_record_date = transdate($kontrolkonto, $date_to, 'prev');
						}
					}
				}
			}
*/
			if ($d_type[$y] == 'F' && $debet[$y] == $kontrolkonto) {
				$kontrolsaldo += $dkkamount[$y] / $tmp; # 20230302
			}
			if ($k_type[$y] == 'F' && $kredit[$y] == $kontrolkonto) {
				$kontrolsaldo -= $dkkamount[$y] / $tmp; # 20230302
			}
#			if ($debet[$y] === '' && $kredit[$y] === '')	$kontrolsaldo = ''; #outcommented 20240401
		}

		if ($id[$y] && $debet[$y] && is_numeric($debet[$y]) && $kredit[$y] && is_numeric($kredit[$y]))
			list($dub_bilag[$y], $dub_kladde_id[$y]) = explode(",", find_dublet($id[$y], $transdate[$y], $d_type[$y], $debet[$y], $k_type[$y], $kredit[$y], $amount[$y], $faktura[$y]));
  	print "<tr>";
		if ($vis_bilag && !$fejl && isset($id[$y])) { #### use
			$qtxt = "select id from documents where source = 'kassekladde' and source_id = '$id[$y]'";  //20230630
			if ($dokument[$y] || db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				$clip = 'paper.png';
				$titletxt =  findtekst(1454, $sprog_id);
			} else {
				$clip = 'clip.png';
				$titletxt =  findtekst(1455, $sprog_id);
			}
			print "<td title='$titletxt'><!-- ". __line__ ." -->	";
			$txt = 'Obs - Du har ikke gemt.\n Hvis du klikker OK mistes de sidste ændringer';
			print "<a href=\"javascript:confirmClose('../includes/documents.php?source=kassekladde&&ny=ja&sourceId=$id[$y]&kladde_id=$kladde_id&bilag=$bilag[$y]&bilag_id=$id[$y]&fokus=bila$y&dokument=$dokument[$y]','$txt')\" accesskey='L'>";
#			print "<a href='../includes/documents.php?source=kassekladde&&ny=ja&sourceId=$id[$y]&kladde_id=$kladde_id&bilag=$bilag[$y]&bilag_id=$id[$y]&fokus=bila$y'>";
			print "<img src='../ikoner/$clip' style='width:20px;height:20px;'></a></td>\n";



		}
		if (!isset($dub_bilag[$y]))
			$dub_bilag[$y] = 0;
		if (!isset($dub_kladde_id[$y]))
			$dub_kladde_id[$y] = 0;
		if ($dub_bilag[$y] && $dub_kladde_id[$y]) {
			$title = "title='" . findtekst(1575, $sprog_id) . " $dub_kladde_id[$y] med bilagsnummer $dub_bilag[$y]'";
			$color="color:#FF0000;";
		} else {
			$title=NULL;
			$color=NULL;
		}
		print "<td><input class='inputbox' $title type='text' style='text-align:right;width:50px;$color' name='bila$y' $de_fok value =\"$bilag[$y]\" onchange='javascript:docChange = true;'></td>";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name='dato$y' $de_fok value =\"$dato[$y]\" onchange='javascript:docChange = true;'></td>";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:300px;' name='besk$y' $de_fok value =\"$beskrivelse[$y]\" onchange='javascript:docChange = true;'></td>";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' name='d_ty$y' $de_fok value =\"$d_type[$y]\" onchange='javascript:docChange = true;'></td>";
		if (($k_type[$y]=='D' || $k_type[$y]=='K') && $kredit[$y] && !$debet[$y]) {
			$libtxt=sidste_5($kredit[$y],$k_type[$y],'D');
			print "<td>
			<span onclick=\"return overlib('" . $libtxt . "', WIDTH=800);\" onmouseout='return nd();'>
			<input class='inputbox' type='text' style='text-align:right;width:75px;' name='debe$y' $de_fok value =\"$debet[$y]\" onchange='javascript:docChange = true;'>
			</span></td>\n";
		} else
			print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='debe$y' $de_fok value =\"$debet[$y]\" title='$debettext[$y]' onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' name='k_ty$y' $de_fok value =\"$k_type[$y]\" onchange='javascript:docChange = true;'></td>\n";
		if (($d_type[$y]=='D' || $d_type[$y]=='K') && $debet[$y] && !$kredit[$y]) {
			$libtxt=sidste_5($debet[$y],$d_type[$y],'K');
			print "<td>
			<span onclick=\"return overlib('" . $libtxt . "', WIDTH=800);\" onmouseout='return nd();'>
			<input class='inputbox' type='text' style='text-align:right;width:75px;' name='kred$y' $de_fok value =\"$kredit[$y]\" onchange='javascript:docChange = true;'>
			</span></td>\n";
		} else
			print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='kred$y' $de_fok value =\"$kredit[$y]\" title= '$kredittext[$y]' onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='fakt$y' $de_fok value =\"$faktura[$y]\" onchange='javascript:docChange = true;'></td>\n";
		if (!isset($valuta[$y])) $valuta[$y] = 'DKK';
		if ($valuta[$y]=='DKK') $title="";
		else $title="DKK: ".dkdecimal($dkkamount[$y],2);
		print "<td title='$title'><input class='inputbox' type='text' style='text-align:right;width:100px;' name='belo$y' 
		$de_fok value ='" . dkdecimal($amount[$y], 2) . "' onchange='javascript:docChange = true;'></td>\n";
		if ($vis_afd) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='afd_$y' 
			$de_fok value =\"$afd[$y]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_ansat) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='meda$y' 
			$de_fok value =\"$ansat[$y]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_projekt) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='proj$y' 
			$de_fok value =\"$projekt[$y]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_valuta)
			print "<td><input class='inputbox' type='text' style='text-align:left;width:40px;' name='valu$y' $de_fok value =\"$valuta[$y]\" onchange='javascript:docChange = true;'></td>\n";
		if ($k_type[$y]=='K' || $d_type[$y]=='D') {
			print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name='forf$y' $de_fok value =\"$forfaldsdato[$y]\" onchange='javascript:docChange = true;'></td>\n";
			if ($vis_bet_id)
				print "<td><input class='inputbox' type='text' style='text-align:left;width:100px;' name='b_id$y' $de_fok value =\"$betal_id[$y]\" onchange='javascript:docChange = true;'></td>\n";
		} elseif ($vis_forfald) {
			print "<td><input class='inputbox' style='left;width:75px;' readonly='readonly' size='10'><br></td>\n";
			if ($vis_bet_id)
				print "<td><input class='inputbox' readonly='readonly' size='10'><br></td>\n";
		}
		if ($momsfri[$y] == 'on') {
			print "<td align='center'><input class='inputbox' type=checkbox name=moms$y checked onchange='javascript:docChange = true;' ></td>\n";
		} else {
			print "<td align='center'><input class='inputbox' type=checkbox name=moms$y onchange='javascript:docChange = true;'></td>\n";
		}
		if ($control_bal_fetched) {
			$titletxt = findtekst("Kontrolsaldo er nu beregnet fra ", $sprog_id); # "The control balance is calculated from "
			$titletxt .= $control_record_date;
			$titletxt .= findtekst(", fordi der blev bogført på kontrolkontoen denne dato!", $sprog_id); # " because there was transactions on the control account this date!"
			print "<td style='text-align:right;font-weight:bold' title='" . $titletxt . "'>" . dkdecimal($kontrolsaldo, 2) . "</td>\n";
			$control_bal_fetched = FALSE;
		} elseif ($kontrolsaldo) {
			print "<td align=right>" . dkdecimal($kontrolsaldo, 2) . "</td>\n";
		}
		if ($saldo[$y]) {
			$saldoDiff = afrund($saldo[$y], 2) - afrund($kontrolsaldo, 2);
			($saldoDiff) ? $color = "style='color:red'" : $color = "style='color:black'";
			print "<td>&nbsp;</td><td align='right'><div $color>" . dkdecimal($saldo[$y]) . "</div></td>\n";
			if ($saldoDiff)
				print "<td>&nbsp;</td><td align='right'><div $color>(" . dkdecimal($saldoDiff) . ")</div></td>\n";
		}
		print "<input type=hidden name='id[$y]' value='$id[$y]'>";
		print "<input type=hidden name='dkka$y' value='$dkkamount[$y]'>";
		print "<input type=hidden name='transdate[$y]' value='$transdate[$y]'>";
		print "</tr>\n";
		if ($kksort=="bilag,transdate") {
			if ($bilag[$y] != $bilag[$y-1]) {
				$debetsum=0;
				$kreditsum=0;
				$amount[$x+1]=0;
			}
			if ((($debet[$y])||($kredit[$y]))&&($amount[$y] > 0)) {
				if (($debet[$y]) || ($debet[$y] > 0))
					$debetsum = $debetsum + $dkkamount[$y];
				if (($kredit[$y]) || ($kredit[$y] > 0))
					$kreditsum = $kreditsum + $dkkamount[$y];
				if ((!$bilag[$x + 1]) || ($bilag[$x + 1] < $bilag[$y]))
					$bilag[$x + 1] = $bilag[$y];
				if (!$dato[$x + 1])
					$dato[$x + 1] = $dato[$y];
				$amount[$x+1]=$debetsum-$kreditsum;
			}
		}
	}
	$aa=$x+1;
	//if (!isset($amount[$x+1])) $amount[$x+1]=0;
	if (!array_key_exists($x + 1, $amount))
		$amount[$x + 1] = 0;
	if (abs($amount[$x+1])>0.01) {
		$beskrivelse[$x+1]=$beskrivelse[$x];
		$bilag[$x+1]=$bilag[$x];
		//$dato[$x+1]=$dato[$x];
		isset($dato[$x]) && $dato[$x + 1] = $dato[$x];
		//$valuta[$x+1]=$valuta[$x]; #20121110 Rettet fra $valuta[$x+1]='DKK' 
		isset($valuta[$x]) && $valuta[$x + 1] = $valuta[$x];
	} elseif ($bilag[$x + 1] == $bilag[$x]) {
		//if (isset($amount[$x+1]) && $amount[$x] > 0) {
		if (isset($amount[$x])) {
			if (array_key_exists($x + 1, $amount) && $amount[$x] > 0) { //20230710
			$amount[$x+1]='';
				if ($bilag[$x] != '0')
					$bilag[$x + 1] = $bilag[$x] + 1;
				//$dato[$x+1]=$dato[$x];
				isset($dato[$x]) && $dato[$x + 1] = $dato[$x];
			}
		}
	}#end if($bilag[$x+1]==$bilag[$x])

	if ($x > 20) {
		$y = $x + 5;
	} else {
		$y = 24;
	}
	$x++;
	if (!$amount[$x])  $amount[$x] = 0;
	if ($amount[$x]<0) $amount[$x] = $amount[$x]*-1;
	if ($amount[$x]) $belob=dkdecimal($amount[$x],2);
	else $belob="";
	if (!isset($amount[$x-1]))$amount[$x-1]=0;
	if (($amount[$x-1])&&($amount[$x-1]<0.01)) {
		$bilag[$x]="";
		$dato[$x]="";
		$belob="";
	}
	if ($fokus && (strstr($fokus,"belo") || strstr($fokus,"afd")) && strstr($submit,'save')) {
		$tmp=substr($fokus,4)+1;
		if (!$debet[$tmp] && !$kredit[$tmp])
			$fokus = nextfokus($fokus);
	}
	if (!isset($dato[$y]))         $dato[$y]        = NULL;
	if (!isset($beskrivelse[$y]))  $beskrivelse[$y] = NULL;
	if (!isset($debet[$y]))        $debet[$y]       = NULL;
	if (!isset($kredit[$y]))       $kredit[$y]      = NULL;
	if (!isset($faktura[$y]))      $faktura[$y]     = NULL;
	if (!isset($valuta[$y]))       $valuta[$y]       = NULL;
	if (((($bilag[$x] == "-") || (!$dato[$y] && !$beskrivelse[$y] 
		&& !$debet[$y] && !$kredit[$y] && !$faktura[$y] && !$amount[$x])) && ($x == 1)) || (!$kladde_id)) {
		$bilag[$x]=1;
		$qtxt = "select MAX(bilag) as bilag from kassekladde where transdate>='$regnstart' and transdate<='$regnslut'";
		$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
		if ($row = db_fetch_array($q)) $bilag[$x] = $row['bilag'] + 1;
	}
	if (!isset($debet[$x - 1]))       $debet[$x - 1] = NULL;
	if (!isset($kredit[$x - 1]))      $kredit[$x - 1] = NULL;
	if (($bilag[$x])&&(!$dato[$x])) $dato[$x]=dkdato(date("Y-m-d"));
	if ($x<3000 && (($debet[$x-1])||($kredit[$x-1])||$x==1)) {
		if (!isset($id[$x]))$id[$x]=NULL;
		if (!isset($dato[$x]))        $dato[$x]        = NULL;
		if (!isset($beskrivelse[$x])) $beskrivelse[$x] = NULL;
		if (!isset($debet[$x]))       $debet[$x]       = NULL;
		if (!isset($kredit[$x]))      $kredit[$x]      = NULL;
		if (!isset($faktura[$x]))     $faktura[$x]     = NULL;
		if (!isset($d_type[$x]))      $d_type[$x]      = NULL;
		if (!isset($k_type[$x]))      $k_type[$x]      = NULL;
		if (!isset($afd[$x]))         $afd[$x]         = NULL;
		if (!isset($momsfri[$x]))     $momsfri[$x]     = NULL;
		if (!isset($projekt[$x]))     $projekt[$x]     = NULL;
		if (!isset($valuta[$x]))      $valuta[$x]      = NULL;
		if (!isset($ansat[$x]))       $ansat[$x]       = NULL;
		print "<tr>";
		if ($vis_bilag && !$fejl) { #20140425
			#if ($kladde_id && $intern_bilag) print "<td title='".findtekst(1455, $sprog_id)."'><a href='../includes/bilag.php?kilde=kassekladde&bilag_id=$id[$x]&bilag=$bilag[$x]&ny=ja&kilde_id=$kladde_id&fokus=bila$x'><img  style='border: 0px solid' src='../ikoner/clip.png'></a></td>\n";
			if ($kladde_id && $intern_bilag) {
				$id[$y] = (int) isset($id[$y]);
				$qtxt = "select id from documents where source = 'kassekladde' and source_id = '$id[$y]'";  //20230630
				if ($dokument[$y] || db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
					$clip = 'paper.png';
					$titletxt =  findtekst(1454, $sprog_id);
				} else {
					$clip = 'clip.png';
					$titletxt =  findtekst(1455, $sprog_id);
				}
				$txt = 'Obs - Du har ikke gemt.\n Hvis du klikker OK mistes de sidste ændringer';
				print "<td title='$titletxt'>";
				print "<a href=\"javascript:confirmClose('../includes/documents.php?source=kassekladde";
				print "&ny=ja&sourceId=". if_isset($id[$x],0) ."&kladde_id=$kladde_id&bilag=$bilag[$x]";
				print "&bilag_id=". if_isset($id[$x],0) ."&fokus=bila$y','$txt')\" accesskey='L'>";
#				print "<a href='../includes/documents.php?source=kassekladde&&ny=ja&sourceId=" . if_isset($id[$y],0); 
#				print "&kladde_id=$kladde_id&bilag=$bilag[$x]&bilag_id=" . if_isset($id[$y],0) ."&fokus=bila$y' onclick='this.form.submit()'>";
				print "<img src='../ikoner/$clip' style='width:20px;height:20px;'></a></td>\n";


				// print "</tr>";
			} else {
				print "<td></td>\n";
			}
		}
		print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' 
		name='bila$x' $de_fok value =\"$bilag[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' 
		name='dato$x' $de_fok value =\"$dato[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:300px;' 
		name='besk$x' $de_fok value =\"$beskrivelse[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' 
		name='d_ty$x' $de_fok value =\"$d_type[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' 
		name='debe$x' $de_fok value =\"$debet[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' 
		name='k_ty$x' $de_fok value =\"$k_type[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' 
		name='kred$x' $de_fok value=\"$kredit[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' 
		name='fakt$x' $de_fok value=\"$faktura[$x]\" onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:100px;' 
		name='belo$x' $de_fok value=\"$belob\" onchange='javascript:docChange = true;'></td>\n";
		if ($vis_afd) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' 
			name='afd_$x' $de_fok value=\"$afd[$x]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_ansat) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' 
			name='meda$x' $de_fok value =\"$ansat[$x]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_projekt) {
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' 
			name='proj$x' $de_fok value =\"$projekt[$x]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if ($vis_valuta) {
			print "<td><input class='inputbox' type='text' style='text-align:left;width:40px;' 
			name='valu$x' $de_fok value =\"$valuta[$x]\" onchange='javascript:docChange = true;'></td>\n";
		}
		if (!isset ($k_type[$y])) $k_type[$y]=NULL;
		if (!isset ($d_type[$y])) $d_type[$y]=NULL;
		if ($k_type[$y]=='K' || $d_type[$y]=='D') {
			print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' 
			name='forf$x' $de_fok value =\"$forfaldsdato[$x]\" onchange='javascript:docChange = true;'></td>\n";
			print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' 
			name='b_id$x' $de_fok value =\"$betal_id[$x]\" onchange='javascript:docChange = true;'></td>\n";
		} elseif ($vis_forfald) {
			print "<td><input  class='inputbox' readonly='readonly' style='left;width:75px;' size='10'><br></td>\n";
			if ($vis_bet_id)
				print "<td><input  class='inputbox' readonly='readonly' size='10'><br></td>\n";
		}
		if ($momsfri[$x] == 'on') {
			print "<td align='center'><input class='inputbox' type='checkbox' name='moms$x' checked onchange='javascript:docChange = true;'></td>\n";
		} else {
			print "<td align='center'><input class='inputbox' type='checkbox' name='moms$x' onchange='javascript:docChange = true;'></td>\n";
		}
	}
	#cho __line__." X $x<br>";	
	if ($x != 1 || $bilag[$x])
		$bilagsnr = $bilag[$x];
	if ($x < 3000) {
		if ($x > 6) {
			$y = $x + 5;
		} else {
			$y = 10;
		}
		if ($fejl)
			$y = $x;
	} else
		$y = $x - 1;
	#cho __line__." Y $y<br>";  	

	$x++;
	if ($x == 1) {
		$bilag[1] = '';
		$dato[1] = '';
		$beskrivelse[1] = '';
		$d_type[1] = '';
		$debet[1] = '';
		$k_type[1] = '';
		$kredit[1] = '';
		$faktura[1] = '';
		$belob[1] = '';
		$momsfri[1] = '';
		$afd[1] = '';
	}
	for ($z=$x;$z<=$y;$z++) {
		print "<tr>";
		if ($vis_bilag && !$fejl)
			print "<td><br></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='bila$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name='dato$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:300px;' name='besk$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' name='d_ty$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='debe$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:left;width:25px;' name='k_ty$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='kred$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:75px;' name='fakt$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		print "<td><input class='inputbox' type='text' style='text-align:right;width:100px;' name='belo$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_afd)
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='afd_$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_ansat)
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='meda$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_projekt)
			print "<td><input class='inputbox' type='text' style='text-align:right;width:50px;' name='proj$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_valuta)
			print "<td><input class='inputbox' type='text' style='text-align:left;width:40px;' name='valu$z' $de_fok onchange='javascript:docChange = true;'></td>\n";
		#		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name=forf$z $de_fok onchange='javascript:docChange = true;'></td>\n";
#		print "<td><input class='inputbox' type='text' style='text-align:left;width:75px;' name=b_id$z $de_fok onchange='javascript:docChange = true;'></td>\n";
		if ($vis_forfald) {
			print "<td><input  class='inputbox'  style='left;width:75px;' readonly='readonly' size='10'><br></td>\n";
			if ($vis_bet_id)
				print "<td><input  class='inputbox' readonly='readonly' size='10'><br></td>\n";
		}
		print "<td align='center'><input class='inputbox' type='checkbox' name='moms$z' onchange='javascript:docChange = true;'></td>\n";
		print "</tr>\n";
	}
	#	if (count($bilag)<10) print "<tr><td align='center' colspan='8'>".findtekst(598, $sprog_id)."</td></tr>";
	print "<input type='hidden' name='fokus' id='fokus'>";
	print "<input type=hidden name=kladde_id value=$kladde_id>";
	$tidspkt=microtime();
	print "<input type=hidden name=tidspkt value='$tidspkt'>";
	print "<input type=hidden name=bilagsnr value='$bilagsnr'>";
	print "<input type=hidden name=antal_ex value='$antal_ex'>";
	print "<input type=hidden name=antal_ny value='$y'>";
} #end if $bogfort...else

	($udskriv)?$div='':$div='</div>';
	?>
	<script	src="../javascript/jquery-1.10.2.min.js"></script>
	<script	src="../javascript/jquery.formnavigation.js"></script>
	<script>
	$(document).ready(function () {
		$('.formnavi').formNavigation();
	});
	</script>
	<?php
	print "</tbody></table></td><td></td></tr>"; # Tabel 1.3 <- Kladdelinjer
	print "<tr><td><br></td></tr>\n";
	print "<tr><td align='center'>";
	if ($menu == 'T') {
		print "<table width='900px' border='0' cellspacing='0' cellpadding='1'><tbody><tr>"; # Tabel 1.4 -> Knapper
	} else {
		print "<table width='800px' border='0' cellspacing='0' cellpadding='1'><tbody><tr>"; # Tabel 1.4 -> Knapper
	}
	if (!$udskriv) {
	if ($bogfort=='V'){
			#		print "<input type=hidden name=ny_kladdenote value='$kladdenote'>";
			print "<tr><td colspan=9 align='center'><input type='submit' class='button gray medium' accesskey='k' value=\"" . findtekst(1598, $sprog_id) . "\" name='copy2new' onclick='javascript:docChange = false;'></td></tr>\n";
		print "</form>";
#		print "</tbody></table></td></tr>\n";
#		print "</tbody></table>";
	} elseif ($bogfort=='!'){
			#		print "<input type=hidden name=ny_kladdenote value='$kladdenote'>";
			print "<tr><td colspan=9 align='center'><input type='submit' accesskey='b' value='" . findtekst(1597, $sprog_id) . "' name='revert' onclick='javascript:docChange = false;'></td></tr>\n";
		print "</form>";
#		print "</tbody></table></td></tr>\n";
#		print "</tbody></table>";
	} elseif ($bogfort=='S'){
			print "<tr><td colspan=9 align='center'><input type='submit' class='button rosy medium' accesskey='a' value='" . findtekst(1090, $sprog_id) . "' name='cancelSimulation' onclick='javascript:docChange = false;'></td></tr>\n";
		print "</form>";
	} else {
			print "<td align='center'><span title='" . findtekst(1544, $sprog_id) . "'><input type='submit' class='button green medium' style='width:120px;' accesskey='g' value='" . findtekst(3, $sprog_id) . "' name='save' onclick='javascript:docChange = false;'></span></td>\n";
			print "<td align='center'><span title='" . findtekst(1545, $sprog_id) . "'><input type='submit' class='button blue medium' style='width:120px;' accesskey='o' value='" . findtekst(644, $sprog_id) . "' name='lookup' onclick='javascript:docChange = false;'></span></td>";
		if ($kladde_id && !$fejl) {
				print "<td align='center'><span title='" . findtekst(1546, $sprog_id) . "'><input type='submit' class='button gray medium' style='width:120px;' accesskey='s' value='" . findtekst(1064, $sprog_id) . "' name='simulate' onclick='javascript:docChange = false;'></span></td>";
				print "<td align='center'><span title='" . findtekst(1547, $sprog_id) . "'><input type='submit' class='button gray medium' style='width:120px;' accesskey='b' value='" . findtekst(1065, $sprog_id) . "' name='doPost' onclick='javascript:docChange = false;'></span></td>";
				$qtxt = "select box5 from grupper where art = 'DIV' and kodenr = '3'";
				if (!$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
					$qtxt = "select id from ordrer where status=3";
					if ($r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
						print "<td align='center'><span title='" . findtekst(1548, $sprog_id) . "'><input type='submit' style='width:120px;float:left' accesskey='h' value='" . findtekst(1078, $sprog_id) . "' name='upload' onclick='javascript:docChange = false;'></span></td>";
					}
			}
				$qtxt = "select * from grupper where art = 'DIV' and kodenr = '2' and box6='on'";
				if (db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				$confirm1= findtekst(1576, $sprog_id);
					print "<td align='center'><input type='submit' style='width:120px;float:left' accesskey='d' value='DocuBizz' name='submit' onclick='javascript:docChange = false;' onclick=\"return confirm('$confirm1')\"></td>"; #20210720
			}
				print "<td align='center'><span title='" . findtekst(1549, $sprog_id) . "'><input type='submit' class='button gray medium' style='width:120px;' accesskey='i' value='" . findtekst(1356, $sprog_id) . "' name='import' onclick='javascript:docChange = false;'></span></td>";
				print "<td align='center'><span title='" . findtekst(1550, $sprog_id) . "'><input type='submit' class='button gray medium' style='width:120px;' accesskey='u' value='" . findtekst(1066, $sprog_id) . "' name='offset' onclick='javascript:docChange = false;'></span></td>";
		}
	}
	print "</form>";
	}
	print "</tbody></table></td></tr>\n"; # Tabel 1.4 <- Knapper
#	if ($udskriv) print "<tr><td width=\"100%\" height=\"100%\">zz</td></tr>";
	print "</tbody></table>"; # Tabel 1 <-
	if ($udskriv) {
		print "<body onload=\"javascript:window.print()\">";#;javascript:window.close();\">";

	}
	#############################################################################################################################
	function kontroller($id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $kontonr, $kladde_id, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $lobenr)
	{
	global $bilagsrenum; //20160909
	global $bilagscount; //20160909
	global $connection;
	global $debitornr;
	global $fejl;
	global $find;
	global $fokus;
	global $opslag_id;
	global $prebilag;
	global $regnaar;
	global $sletrest,$sprog_id;
	global $restlig;
	global $submit;
	global $x;
	global $aarstart;
	global $aarslut;

	$lukket=NULL;
	if ($kladde_id) {
			$qtxt = "select bogfort from kladdeliste where id = $kladde_id";
			$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
			if ($r['bogfort'] != '-') {
			$alerttxt = findtekst(1584, $sprog_id);
			print "<BODY onload=\"javascript:alert('$alerttxt')\">";
			print "<meta http-equiv=\"refresh\" content=\"0;URL=../includes/luk.php\">";
			exit;
		}
	}

	if (!$aarstart) {
		$query = db_select("select box1, box2, box3, box4 from grupper where art='RA' and kodenr='$regnaar'",__FILE__ . " linje " . __LINE__);
		if ($row = db_fetch_array($query)) {
			$md1=trim($row['box1']);
			$year1=trim($row['box2']);
			$md2=trim($row['box3']);
			$year2=trim($row['box4']);
			if (strlen($md1)<2 || strlen($md2)<2) {
					if (strlen($md1) < 2)
						$md1 = '0' . $md1;
					if (strlen($md2) < 2)
						$md2 = '0' . $md2;
				db_modify("update grupper set box1='$md1',box3='$md2' where art='RA' and kodenr='$regnaar'",__FILE__ . " linje " . __LINE__);
			}
			$aarstart=$year1.$md1;
			$aarslut=$year2.$md2;
	 	}
	}
#	(!$bilag) {$bilag=$prebilag;} PHR 02.10.06
#	if ($bilag=="-"){$bilag="";} PHR 02.10.06
#	if ($bilag=='-*') $sletrest=1;
#	if ($sletrest) $bilag='-';
		if ($bilag && $bilag != '0' && substr($bilag, -1) != 'r' && $bilag != '-')
			$bilag = (int) $bilag; 	//20160909 undtaget * til bilagsrenum
	$debet=trim($debet);
	$kredit=trim($kredit);
	if (($bilag != "-")&&(($bilag)||($beskrivelse)||($kredit)||($debet)||($faktura)||($belob))) {
			if ((!$bilag) && ($bilag != '0'))
				$bilag = $prebilag;
			if (!$bilag)
				$bilag = '0';
			if ((strstr($d_type, "d")) || (strstr($d_type, "D")))
				$d_type = "D";
			elseif ((strstr($d_type, "k")) || (strstr($d_type, "K")))
				$d_type = "K";
			else {
				$d_type = "F";
			}

			if ((strstr($k_type, "d")) || (strstr($k_type, "D")))
				$k_type = "D";
			elseif ((strstr($k_type, "k")) || (strstr($k_type, "K")))
				$k_type = "K";
			else
				$k_type = "F";
			if (!$debet)
				$debet = 0;
			if (!$kredit)
				$kredit = 0;
		if (!$lukket) {
			$lukket=array();
			$y=0;
				$accountNumbers = array();
			$query = db_select("select kontonr,lukket from kontoplan where kontotype != 'H' and kontotype != 'Z' and regnskabsaar=$regnaar",__FILE__ . " linje " . __LINE__);
			while($row = db_fetch_array($query)) {
				$y++;
					$accountNumbers[$y] = trim($row['kontonr']);
				if ($row['lukket']) {
						$lukket[$y] = $accountNumbers[$y];
				}
			}
		}
			#cho __line__." $submit $debet[$x] $fokus $x<br>";

		if (($d_type=="D")||($k_type=="D")||($d_type=="K")||($k_type=="K")) {
			$z=0;
			$y=0;
			$query = db_select("select kontonr, art from adresser",__FILE__ . " linje " . __LINE__);
			while ($row = db_fetch_array($query)) {
				if (strstr($row['art'],"D")) {
					$z++;
					$debitornr[$z]=trim($row['kontonr']);
				}
				if (strstr($row['art'],"K")){
					$y++;
					$kreditornr[$y]=trim($row['kontonr']);
				}
			}

		}
			#cho __line__." $submit $debet[$x] $fokus $x<br>";
		if ($d_type=="F" && strlen($debet)==1 && !is_numeric($debet) && $debet!='0') {
			$debet=strtoupper($debet);
			$query = db_select("select kontonr from kontoplan where genvej='$debet' and regnskabsaar='$regnaar'",__FILE__ . " linje " . __LINE__);
				if ($row = db_fetch_array($query))
					$debet = $row[kontonr];
			else {
				$txt1 = findtekst(1585, $sprog_id);
				$txt2 = findtekst(1586, $sprog_id);
					$alerttekst = addslashes($debet . " " . $txt1 . " " . $bilag . $txt2); # 20230306 added spaces
				alert($alerttekst);
				$fejl=1;
			}
		}
			#cho __line__." $submit $debet[$x] $fokus $x<br>";
			if (($d_type == "F" && strlen($debet) > 1 && !is_numeric($debet))) {
			$i=0;
				$d = $debet;
				$ld = strtolower($debet);
				$ud = strtoupper($debet);
				$qtxt = "select beskrivelse,kontonr from kontoplan where (kontotype = 'D' or kontotype = 'S') and ";
				$qtxt .= "regnskabsaar='$regnaar' and lukket != 'on' order by beskrivelse";
				$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
				while ($r = db_fetch_array($q)) {
					$t = $r['beskrivelse'];
					$lt = strtolower($t);
					$ut = strtoupper($t);
					if (strstr($t, $d) || strstr($lt, $ld) || strstr($ut, $ud)) {
						$findarray[$i] = $r['kontonr'];
				$i++;
				}
			}
				if ($i == 1) {
					$debet = $findarray[0];
				} elseif ($i > 1) {
					include('kassekladde_includes/financeLookup.php');
					financeLookup($findarray, 'firmanavn', $fokus, $opslag_id, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $opslag_id);
		}
			} elseif (($k_type == "F") && (strlen($kredit) > 1) && (!is_numeric($kredit))) {
				$i = 0;
				$k = $kredit;
				$lk = strtolower($kredit);
				$uk = strtoupper($kredit);
				$qtxt = "select beskrivelse,kontonr from kontoplan where (kontotype = 'D' or kontotype = 'S') and ";
				$qtxt .= "regnskabsaar='$regnaar' and lukket != 'on' order by beskrivelse";
				$q = db_select($qtxt, __FILE__ . " linje " . __LINE__);
				while ($r = db_fetch_array($q)) {
					$t = $r['beskrivelse'];
					$lt = strtolower($t);
					$ut = strtoupper($t);
					if (strstr($t, $k) || strstr($lt, $lk) || strstr($ut, $uk)) {
						$findarray[$i] = $r['kontonr'];
				$i++;
			}
				}
				if ($i == 1)
					$debet = $findarray[$i];
				elseif ($i > 1) {
					include('kassekladde_includes/financeLookup.php');
					financeLookup($findarray, 'firmanavn', $fokus, $opslag_id, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $opslag_id);
			}
		}
		if (!$fejl && $k_type=="F" && strlen($kredit)==1 && !is_numeric($kredit) && $kredit!='0') {
				$qtxt = "select kontonr from kontoplan where genvej='" . strtoupper($kredit) . "' and regnskabsaar='$regnaar'";
				$query = db_select($qtxt, __FILE__ . " linje " . __LINE__);
				if ($row = db_fetch_array($query))
					$kredit = $row['kontonr'];
			else {
					$alert1 = findtekst(1585, $sprog_id);
					$alert2 = findtekst(1586, $sprog_id);

					$alerttekst = addslashes($kredit . " " . $txt1 . " " . $bilag . $txt2); # 20230306 added spaces
				alert($alerttekst);
				$fejl=1;
			}
		}
		if ((!$fejl)&&($d_type=="F")&&($debet>0)) {
			$alerttekst='';
				if (!in_array($debet, $accountNumbers)) {
				$alerttxt1 = findtekst(1589, $sprog_id);
				$alerttxt2 = findtekst(1590, $sprog_id);
				$alerttxt3 = findtekst(1586, $sprog_id);
				$alerttxt4 = findtekst(1591, $sprog_id);
				$alerttxt5 = findtekst(1592, $sprog_id);
				

					$alerttekst = addslashes($alerttxt1 . " '" . $debet . "' " . $alerttxt2 . " " . $bilag . $alerttxt3); # 20230306 added ' and spaces
				} elseif (in_array($debet, $lukket))
					$alerttekst = addslashes($alerttxt4 . " " . $debet . " " . $alerttxt5 . " " . $bilag . $alerttxt3); # 20230306 added spaces
			if ($alerttekst) {
					alert("$alerttekst");
				$fejl=1;
			}
		}
		if ((!$fejl)&&($k_type=="F")&&($kredit>0)) {
			$alerttekst='';
			$alert1=findtekst(1593,$sprog_id);
			$alert2=findtekst(1594,$sprog_id);
			$alert3=findtekst(1588,$sprog_id);
			$alert4=findtekst(1586,$sprog_id);


				if (!in_array($kredit, $accountNumbers)) {
					$alerttekst = addslashes($alert1 . " '" . $kredit . "' " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				} elseif (in_array($kredit, $lukket))
					$alerttekst = addslashes($alert1 . " " . $kredit . " " . $alerttxt4 . " " . $bilag . $alert4);
			if ($alerttekst) {
				alert($alerttekst);
				$fejl=1;
			}
		}
		if ((!$fejl)&&($d_type=="D")&&($debet)&&(!in_array($debet,$debitornr))) {
			$alerttekst='';
			$alert1=findtekst(604,$sprog_id);
			$alert2=findtekst(1594,$sprog_id);
			$alert3=findtekst(1588,$sprog_id);
			$alert4=findtekst(1586,$sprog_id);

			$svar=find_kontonr($fokus,'D',$debet,$id,$kladde_id,$bilag,$dato,$beskrivelse,$d_type,$debet,$k_type,$kredit,$faktura,$belob,$momsfri,$afd,$projekt,$ansat,$valuta,$forfaldsdato,$betal_id,$x);
				if ($svar == $debet)
					$alerttekst = addslashes($alert1 . " " . $debet . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				else
					$debet = $svar;
			if ($alerttekst) {
				alert($alerttekst);
				$fejl=1;
			}
		}
		if ((!$fejl)&&($k_type=="D")&&($kredit)&&(!in_array($kredit,$debitornr))) {
			$alerttekst='';
			$alert1=findtekst(604,$sprog_id);
			$alert2=findtekst(1594,$sprog_id);
			$alert3=findtekst(1588,$sprog_id);
			$alert4=findtekst(1586,$sprog_id);

			$svar=find_kontonr($fokus,'D',$kredit,$id,$kladde_id,$bilag,$dato,$beskrivelse,$d_type,$debet,$k_type,$kredit,$faktura,$belob,$momsfri,$afd,$projekt,$ansat,$valuta,$forfaldsdato,$betal_id,$x);
				if ($svar == $kredit)
					$alerttekst = addslashes($alert1 . " " . $kredit . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				else
					$kredit = $svar;
			if ($alerttekst) {
				alert($alerttekst);
				$fejl=1;
			}
		}
		if ((!$fejl)&&($d_type=="K")&&($debet)&&(!in_array($debet,$kreditornr))) {
			$alerttekst='';
			$alert1=findtekst(1169,$sprog_id);
			$alert2=findtekst(1594,$sprog_id);
			$alert3=findtekst(1588,$sprog_id);
			$alert4=findtekst(1586,$sprog_id);
			$svar=find_kontonr($fokus,'K',$debet,$id,$kladde_id,$bilag,$dato,$beskrivelse,$d_type,$debet,$k_type,$kredit,$faktura,$belob,$momsfri,$afd,$projekt,$ansat,$valuta,$forfaldsdato,$betal_id,$x);
				if ($svar == $debet)
					$alerttekst = addslashes($alert1 . " " . $debet . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				else
					$debet = $svar;
			if ($alerttekst) {
				alert($alerttekst);
				$fejl=1;
			}
		}
		if ((!$fejl)&&($k_type=="K")&&($kredit)&&(!in_array($kredit,$kreditornr))) {
			$alerttekst='';
			$alert1=findtekst(1169,$sprog_id);
			$alert2=findtekst(1594,$sprog_id);
			$alert3=findtekst(1588,$sprog_id);
			$alert4=findtekst(1586,$sprog_id);
			$svar=find_kontonr($fokus,'K',$kredit,$id,$kladde_id,$bilag,$dato,$beskrivelse,$d_type,$debet,$k_type,$kredit,$faktura,$belob,$momsfri,$afd,$projekt,$ansat,$valuta,$forfaldsdato,$betal_id,$x);
				if ($svar == $kredit)
					$alerttekst = addslashes($alert1 . " " . $kredit . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				else
					$kredit = $svar;
			if ($alerttekst) {
				alert($alerttekst);
				$fejl=1;
			}
		}
			if ($d_type == "K" && strtoupper($debet) == "K")
				$debet = 0;
			if ($d_type == "D" && strtoupper($debet) == "D")
				$debet = 0;
			if ($k_type == "K" && strtoupper($kredit) == "K")
				$kredit = 0;
			if ($k_type == "D" && strtoupper($kredit) == "D")
				$kredit = 0;
		$transdate=usdate($dato);
			#cho __line__." $transdate<br>";
		list ($year,$month,$day) = explode ('-',$transdate);
		$ym=$year.$month;
		if (!$fejl && $dato && ($ym<$aarstart || $ym>$aarslut)) {
			$alert1=findtekst(635,$sprog_id);
			$alert2=findtekst(1595,$sprog_id);
			$alert3=findtekst(1588,$sprog_id);
			$alert4=findtekst(1586,$sprog_id);
						#'Dato ('.$dato.') udenfor regnskabs&aring;r (Bilag nr '.$bilag.') Kladden er IKKE gemt!';
						
				$alerttekst = $alert1 . " (" . $dato . ") " . $alert2 . " " . $alert3 . " " . $bilag . $alert4;
			alert($alerttekst);
			$fejl=1;
#			$transdate=date("Y-m-d");
		}
			if (!isset($afd) || !$afd)
				$afd = 0;
		if (!$fejl && $afd) {
			$qtxt = "select id from grupper where art='AFD' and kodenr='$afd'";
			if (!$row= db_fetch_array(db_select($qtxt,__FILE__ . " linje " . __LINE__))) {
				$alert1=findtekst(274,$sprog_id);
				$alert2=findtekst(1594,$sprog_id);
				$alert3=findtekst(1588,$sprog_id);
				$alert4=findtekst(1586,$sprog_id);
					$alerttekst = addslashes($alert1 . " " . $afd . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				alert($alerttekst);
				$fejl=1;
			}
		}
#		$projekt=$projekt*1;
		if (!$fejl&&$projekt) {
			if (!$row= db_fetch_array(db_select("select id from grupper where art='PRJ' and kodenr='$projekt'",__FILE__ . " linje " . __LINE__))){
				$alert1=findtekst(553,$sprog_id);
				$alert2=findtekst(1594,$sprog_id);
				$alert3=findtekst(1588,$sprog_id);
				$alert4=findtekst(1586,$sprog_id);
				                      
					$alerttekst = addslashes($alert1 . " " . $projekt . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				alert($alerttekst);
				$fejl=1;
			}
		}
			if (!$valuta)
				$valuta = 'DKK';
		if ($id && !$fejl && $valuta!='DKK') {
			if (!$row= db_fetch_array(db_select("select kodenr from grupper where art='VK' and box1='$valuta'",__FILE__ . " linje " . __LINE__))){
				$alert1=findtekst(1069,$sprog_id); #20210720
				$alert2=findtekst(1594,$sprog_id);
				$alert3=findtekst(1588,$sprog_id);
				$alert4=findtekst(1586,$sprog_id);
				                       
					$alerttekst = addslashes($alert1 . " " . $valuta . " " . $alert2 . " " . $alert3 . " " . $bilag . $alert4);
				alert($alerttekst);
				$fejl=1;
				} else
					$valutakode = $row['kodenr'];
			$valdate=usdate($dato);
				$qtxt = "select kurs from valuta where gruppe='$valutakode' and valdate <= '$valdate' order by valdate desc limit 1";
				if ($id && !$fejl && $row = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
					db_modify("update kassekladde set valutakurs = '$row[kurs]' where id = '$id'", __FILE__ . " linje " . __LINE__);
			}
		}
		if ($lobenr) {
			if (substr($bilag,-1)=='r') { #20160909.  Er der tastet * som en del af bilagsnummerfeltet?
				$bilagscount = str_replace('r','',$bilag); #20160909 fjern * fra bilagsnummeret
				$bilagsrenum = true; #20160909 ja, der skal renummereres bilag
			}
			if ($bilagsrenum == true) { #20160909 denne bliver loopet igennem for hvert eneste efterfølgende bilag - vi overskriver bilagsunmmeret
					$qtxt = "update tmpkassekl set bilag = '$bilagscount', transdate = '$dato', beskrivelse = '$beskrivelse', d_type = '$d_type', debet = '$debet', k_type = '$k_type', kredit = '$kredit', faktura = '$faktura', amount = '$belob', momsfri = '$momsfri', afd= '$afd', projekt= '$projekt', valuta= '$valuta',forfaldsdate='$forfaldsdato',betal_id='$betal_id' where lobenr = '$lobenr' and kladde_id='$kladde_id'";
				$bilagscount++; #20160909 og her øger vi bilagsnummeret med 1 inden loop
			} else {
					$qtxt = "update tmpkassekl set bilag = '$bilag', transdate = '$dato', beskrivelse = '$beskrivelse', d_type = '$d_type', debet = '$debet', k_type = '$k_type', kredit = '$kredit', faktura = '$faktura', amount = '$belob', momsfri = '$momsfri', afd= '$afd', projekt= '$projekt', valuta= '$valuta',forfaldsdate='$forfaldsdato',betal_id='$betal_id' where lobenr = '$lobenr' and kladde_id='$kladde_id'";
	}

				db_modify($qtxt, __FILE__ . " linje " . __LINE__);
	}
		} elseif ($id && $bilag === "-") {
			$qtxt = "select id from documents where source = 'kassekladde' and source_id = '$id'";
			if(db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__))) {
				alert('Fjern vedhæftet bilag før du sletter linjen');
			} else {
		$qtxt = "delete from kassekladde where id = $id";
		db_modify($qtxt,__FILE__ . " linje " . __LINE__);
	}
		}
	$prebilag=$bilag;
} # endfunc kontroller
######################################################################################################################################
	function opdater($kladde_id)
	{
	global $egen_kto_id;

	$forfaldsdate=NULL;
	$valutakode='0';
	$qtxt = "select * from tmpkassekl where kladde_id = $kladde_id order by lobenr";
	$q = db_select($qtxt,__FILE__ . " linje " . __LINE__);
	while ($r=db_fetch_array($q)) {
		if (($r['bilag']!="-")&&($r['transdate'] || $r['debet'] || $r['kredit'])) {
				if ($r['transdate'])
					$transdate = usdate($r['transdate']);
#			else $transdate=NULL; # <- 2009.05.12
#			else $transdate=date("Y-m-d"); # <- 2009.05.14
				if ($r['forfaldsdate'])
					$forfaldsdate = usdate($r['forfaldsdate']);
				else
					$forfaldsdate = NULL; # <- 2009.05.12
				$amount = usdecimal($r['amount'], 2)*1;
			$momsfri=trim($r['momsfri']);
				$debet = (int) $r['debet'];
				$kredit = (int) $r['kredit'];
			(!$kredit)?$kredit=0:$kredit*=1;
			$d_type=trim($r['d_type']);
			$k_type=trim($r['k_type']);
			$afd=trim($r['afd']);
			(!$afd)?$afd=0:$afd*=1;
			$ansat=strtolower($r['ansat']);
			$faktura=db_escape_string($r['faktura']);
			if ($egen_kto_id && $ansat) {
			$r2=db_fetch_array(db_select("select id from ansatte where lower(initialer) = '$ansat' and konto_id = '$egen_kto_id'",__FILE__ . " linje " . __LINE__));
				$ansat_id=$r2['id']*1;
				} else
					$ansat_id = 0;
			$projekt=$r['projekt'];
			$valuta=$r['valuta'];
			if ($valuta!='DKK') {
				$valuta=strtoupper($valuta);
				# 20120806 Indsat "art = 'VK' and " herunder.
				$qtxt = "select kodenr from grupper where art = 'VK' and box1 = '$valuta'";
				($r2=db_fetch_array(db_select($qtxt,__FILE__ . " linje " . __LINE__)))?$valutakode=$r2['kodenr']:$valutakode=0;
				} else
					$valutakode = 0; #Valutakode 0 er altid DKK
			$betal_id=$r['betal_id'];
			$beskrivelse=db_escape_string($r['beskrivelse']);
			if ($amount < 0) {# Hvis beloebet er negativt, byttes om paa debet og kredit.
					$tmp = $kredit;
					$kredit = $debet;
					$debet = $tmp;
					$tmp = $k_type;
					$k_type = $d_type;
					$d_type = $tmp;
				$amount=$amount*-1;
			}
 			if ($r['id'] && ($r['bilag'] || $r['bilag']=='0')) {
					if (!$transdate && isset($_GET['dato']))
						$transdate = usdate($_GET['dato']);
					if (!$transdate)
						$transdate = date("Y-m-d");
				$qtxt = "update kassekladde set bilag = '$r[bilag]', transdate = '$transdate', beskrivelse = '$beskrivelse', ";
				$qtxt.= "d_type = '$d_type', debet = '$debet', k_type = '$k_type', kredit = '$kredit', faktura = '$faktura', ";
				$qtxt.= "amount = '$amount', momsfri = '$momsfri', afd= '$afd', projekt= '$projekt', ansat= '$ansat_id', ";
				$qtxt.= "valuta= '$valutakode' where id = '$r[id]'";
				db_modify($qtxt,__FILE__ . " linje " . __LINE__);
				if ($forfaldsdate) {
					$qtxt = "update kassekladde set forfaldsdate='$forfaldsdate', betal_id='$betal_id' where id = '$r[id]'";
					} else
						$qtxt = "update kassekladde set forfaldsdate=NULL, betal_id='' where id = '$r[id]'";
				db_modify($qtxt,__FILE__ . " linje " . __LINE__);
				} elseif (
					($r['transdate'] || $transdate)
					&& (($transdate && $transdate != date("Y-m-d")) || $r['beskrivelse'] || $debet | $kredit || $r['faktura'])
				) {
#				$beskrivelse=db_escape_string($r['beskrivelse']);
				$qtxt = NULL;
				if ($forfaldsdate) {
					$qtxt = "insert into kassekladde (bilag, transdate, beskrivelse, d_type, debet, k_type, kredit, ";
					$qtxt.= "faktura, amount, momsfri, afd, projekt, ansat, valuta, kladde_id,forfaldsdate,betal_id)";
					$qtxt.= "values ";
					$qtxt.= "('$r[bilag]', '$transdate', '$beskrivelse', '$d_type', '$debet', '$k_type', '$kredit', ";
					$qtxt.= "'$r[faktura]', '$amount', '$momsfri', '$afd', '$projekt', '$ansat_id', '$valutakode', ";
					$qtxt.= "'$kladde_id','$forfaldsdate','$betal_id')";
					} elseif (($r['bilag'] || $r['bilag'] == '0') && ($beskrivelse || $debet || $kredit || $amount)) {
					$qtxt = "insert into kassekladde (bilag, transdate, beskrivelse, d_type, debet, k_type, kredit, ";
					$qtxt.= "faktura, amount, momsfri, afd, projekt, ansat, valuta, kladde_id)";
					$qtxt.= " values ";
					$qtxt.= "('$r[bilag]', '$transdate', '$beskrivelse', '$d_type', '$debet', '$k_type', '$kredit', ";
					$qtxt.= "'$r[faktura]', '$amount', '$momsfri', '$afd', '$projekt', '$ansat_id', '$valutakode', '$kladde_id')";
				}
					if ($qtxt) {
						db_modify($qtxt, __FILE__ . " linje " . __LINE__);
					}
			}
		}
	}
}
######################################################################################################################################
function tilbagefor($kladde_id) {
	global $regnaar;
	global $connection;

	$query = db_select("select kladdenote from kladdeliste where id = '$kladde_id' and bogfort='!'",__FILE__ . " linje " . __LINE__);
		if ($row = db_fetch_array($query)) {
		db_modify("delete from openpost where kladde_id = '$kladde_id'",__FILE__ . " linje " . __LINE__);
		db_modify("delete from transaktioner where kladde_id = '$kladde_id'",__FILE__ . " linje " . __LINE__);
		db_modify("update kladdeliste set bogfort = '-' where id = '$kladde_id'",__FILE__ . " linje " . __LINE__);
	}
}
######################################################################################################################################
######################################################################################################################################
	function nextfokus($fokus)
	{
	global $id;
	global $amount;
	if ($fokus) {
		$f_id=substr($fokus,4,(strlen($fokus)-4));
			if (strstr($fokus, "bila")) {
				$fokus = "dato" . $f_id;
			} elseif (strstr($fokus, "dato")) {
				$fokus = "besk" . $f_id;
			} elseif (strstr($fokus, "besk")) {
				$fokus = "d_ty" . $f_id;
			} elseif (strstr($fokus, "d_ty")) {
				$fokus = "debe" . $f_id;
			} elseif (strstr($fokus, "debe")) {
				$fokus = "k_ty" . $f_id;
			} elseif (strstr($fokus, "k_ty")) {
				$fokus = "kred" . $f_id;
			} elseif (strstr($fokus, "kred")) {
				$fokus = "fakt" . $f_id;
			} elseif (strstr($fokus, "fakt")) {
				$fokus = "belo" . $f_id;
			} elseif (strstr($fokus, "belo") || strstr($fokus, "afd")) {
			$f_id++;
			$fokus="bila".$f_id;
		}
	} #else $fokus="bila".$x;
# 	if ($amount[$x-1]>0) {$fokus="bila".$x;}

	return $fokus;
}
	/*
##########################################################################################################
function regnskabsaar($regnaar) {
	global $sprog_id; #20210720
	if ($row = db_fetch_array(db_select("select box1, box2, box3, box4 from grupper where art='RA' and kodenr='$regnaar'",__FILE__ . " linje " . __LINE__))){
		$start=trim($row['box2'])."-".trim($row['box1'])."-01";
		$slut=usdate("31-".trim($row['box3'])."-".trim($row['box4']))	; #usdate bruges for at sikre korrekt dato.
	} else {
		#$alerttekst='Regnskabs&aring;r ikke oprettet!';
		$alerttekst=findtekst(1596, $sprog_id);
		alert($alerttekst);
		exit;
	}
	return $start.":".$slut;
}
								  */
######################################################################################################################################
	function indsaet_linjer($kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $afd, $ansat, $projekt, $valuta, $forfaldsdato, $betal_id, $momsfri, $ansat_id)
	{
	global $fejl,$fokus;

	$date=usdate($dato);
	$amount=usdecimal($belob,2);
		if ($forfaldsdato)
			$forfaldsdate = usdate($forfaldsdato);
		else
			$forfaldsdate = NULL;
		#	$bilag = str_replace('+',':',$bilag); #jeg ved ikke hvorfor, men den vil ikke splitte med "+"
#	list ($bilag,$antal) = explode (':',$bilag);
	if ($ansat) {
		$r = db_fetch_array(db_select("select id from adresser where art = 'S'",__FILE__ . " linje " . __LINE__));
		$tmp=$r['id']*1;
		$r = db_fetch_array(db_select("select id from ansatte where initialer = '$ansat' and konto_id = '$tmp'",__FILE__ . " linje " . __LINE__));
		$ansat_id=$r['id'];
	}
	$ansat_id=$ansat_id*1;
	if ($valuta && $valuta!='DKK') {
		$r = db_fetch_array(db_select("select kodenr from grupper where box1 = '$valuta' and art = 'VK'",__FILE__ . " linje " . __LINE__));
			if ($r['kodenr'])
				$valutakode = $r['kodenr'] * 1;
		else {
			$fejl=1;
			print "<BODY onload=\"javascript:alert('Valuta $valuta eksisterer ikke (Bilag $bilag)')\">";
		}
		} else
			$valutakode = 0;
	if (!$fejl) {
			if (!$forfaldsdate)
				$forfaldsdate = $date;
			$qtxt = "insert into kassekladde ";
			$qtxt.= "(bilag,kladde_id,transdate,beskrivelse,d_type,debet,k_type,kredit,";
			$qtxt.= "faktura,amount,afd,ansat,projekt,valuta,forfaldsdate,betal_id,momsfri) values ";
			$qtxt.= "('$bilag','$kladde_id','$date','".db_escape_string($beskrivelse)."','$d_type','$debet','$k_type','$kredit',";
			$qtxt.= "'$faktura','$amount','$afd','$ansat_id','$projekt','$valutakode','$forfaldsdate','$betal_id','$momsfri')";
			db_modify($qtxt,__FILE__ . " linje " . __LINE__);
		}
		if (!$fokus)
			$fokus = "ny_kladdenote";
}
######################################################################################################################################
	function ompost($ompost)
	{
	global $sprog_id;

	$ompost_til=isset($_GET['ompost_til'])? $_GET['ompost_til']:Null;
	$kladde_id=isset($_GET['kladde_id'])? $_GET['kladde_id']:Null;
	$x=0;
	if (!$ompost_til) {
		$x=0;
		print "<table border=\"1\"><tbody>";
		print "<tr><td colspan=3>".findtekst(158,$sprog_id)."</td></tr>";
		print "<tr><td>Kladde_id</td><td>Beskrivelse</td><td>Oprettet&nbsp;af</td></tr>";
		print "<tr><td><a href=kassekladde.php?kladde_id=$kladde_id>".findtekst(159,$sprog_id)."</a></td><td>".findtekst(160,$sprog_id)."</td><td><br></td></tr>";
		$q = db_select("select * from kladdeliste where bogfort='-'",__FILE__ . " linje " . __LINE__);
		while ($r=db_fetch_array($q)){
			$x++;
			print "<tr><td><a href=kassekladde.php?kladde_id=$kladde_id&ompost=$ompost&ompost_til=$r[id]>$r[id]</a></td><td>$r[kladdenote]</td><td>$r[oprettet_af]</td></tr>";
		}
		if ($x==0) {
			print "<body onload=\"javascript:alert('Der skal f&oslash;rst oprettes en kassekladde som posteringen kan tilbagef&oslash;res til')\">";
			print "<meta http-equiv=\"refresh\" content=\"0;URL=kassekladde.php?kladde_id=$kladde_id\">";
		}
		print "<tbody></table>";
		exit;
	} else {
		$r = db_fetch_array(db_select("select * from kassekladde where id = '$ompost'",__FILE__ . " linje " . __LINE__));
			$afd = $r['afd'] * 1;
			$ansat = $r['ansat'] * 1;
			$projekt = $r['projekt'];
			$valutakode = $r['valutakode'] * 1;
		#20140718
		db_modify("insert into kassekladde (bilag,kladde_id,transdate,beskrivelse,d_type,debet,k_type,kredit,faktura,amount,momsfri,afd,ansat,projekt,valuta) values ('$r[bilag]','$ompost_til','$r[transdate]','".db_escape_string($r['beskrivelse'])."','$r[k_type]','$r[kredit]','$r[d_type]','$r[debet]','$r[faktura]','$r[amount]','$r[momsfri]','$afd','$ansat','$projekt','$valutakode')",__FILE__ . " linje " . __LINE__);
		print "<body onload=\"javascript:alert('Posteringen er tilbagef&oslash;rt p&aring; kladde $ompost_til')\">";
	}
} # endfunc ompost
##########################################################################################################
function valutaopslag($amount, $valuta, $transdate) {
	
		$qtxt = "select * from valuta where gruppe = '$valuta' and valdate <= '$transdate' order by valdate desc";
		$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
	if ($r['kurs']) {
		$kurs=$r['kurs'];
		$amount=round($amount*$kurs/100+0.0001,2); # decimal rettet fra 3 til 2 20090617 grundet fejl i saldi_58_20090617-2224
	} else {
			$qtxt = "select box1 from grupper where art = 'VK' and kodenr = '$valuta'";
			$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
		$tmp=dkdato($transdate);
		$fejltext="---";
		print "<BODY onload=\"javascript:alert('Ups - ingen valutakurs for $r[box1] den $tmp')\">";
	}
		$qtxt = "select box3 from grupper where art = 'VK' and kodenr = '$valuta'";
		$r = db_fetch_array(db_select($qtxt, __FILE__ . " linje " . __LINE__));
	$diffkonto=$r['box3'];

	return array($amount,$diffkonto,$kurs); # 3'die parameter tilfojet 2009.02.10
}
##########################################################################################################
	function find_kontonr($fokus, $art, $kontonr, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $opslag_id)
	{
	
	$tmp=db_escape_string(strtolower($kontonr));
	$specChar="À,Á,Â,Ã,Ä,Å,Æ,Ç,È,É,Ê,Ë,Ì,Í,Î,Ï,Ð,Ñ,Ò,Ó,Ô,Õ,Ö,Ø,Ù,Ú,Û,Ü,Ý,Þ,"; #20190503
	$specChar.="ß,à,á,â,ã,ä,å,æ,ç,è,é,ê,ë,ì,í,î,ï,ð,ñ,ò,ó,ô,õ,ö,ø,ù,ú,û,ü,ý,þ,ÿ";
	$chkstr=explode(',',$specChar);
	for ($x=0;$x<count($chkstr);$x++) {
		$tmp=str_replace($chkstr[$x],'%',$tmp);
	}
	$x=0;
	$qtxt="select kontonr from adresser where art = '$art' and lower(firmanavn) like '%$tmp%' and lukket != 'on'";
	$q=db_select($qtxt,__FILE__ . " linje " . __LINE__);
	while ($r = db_fetch_array($q)) {
		$x++;
		$nr=$r['kontonr'];
	}
		if ($x == 1)
			return ($nr);
	elseif ($x>1) {
			if ($art == 'D') {
				include('kassekladde_includes/debitorLookup.php');
				debitorLookup($tmp, 'firmanavn', $fokus, $opslag_id, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $opslag_id);
			} else {
				include('kassekladde_includes/creditorLookup.php');
				creditorLookup($tmp, 'firmanavn', $fokus, $opslag_id, $id, $kladde_id, $bilag, $dato, $beskrivelse, $d_type, $debet, $k_type, $kredit, $faktura, $belob, $momsfri, $afd, $projekt, $ansat, $valuta, $forfaldsdato, $betal_id, $opslag_id);
			}
		} else
			return ($kontonr);
}
##########################################################################################################
	function sidste_5($kontonr, $art, $dk)
	{
	global $kladde_id;
	global $charset;
	global $sprog_id;


		if ($dk == "D")
			$txt = "select bilag,transdate,beskrivelse,debet as kontonr from kassekladde where k_type = '$art' and kredit = '$kontonr' and kladde_id != '$kladde_id' order by transdate desc";
		else
			$txt = "select bilag,transdate,beskrivelse,kredit as kontonr from kassekladde where d_type = '$art' and debet = '$kontonr' and kladde_id != '$kladde_id' order by transdate desc";
	$retur="<table border=1><tbody>";
		if ($art == 'K')
			$retur .= "<tr><td colspan=4>Sidste 5 posteringer for kreditor: $kontonr</td></tr>";
		else
			$retur .= "<tr><td colspan=4>Sidste 5 posteringer for debitor: $kontonr</td></tr>";
	$retur.="<tr><td>bilag</td><td>dato</td><td>tekst</td><td>kontonr</td></tr>";
	$x=0;
	if (is_numeric($kontonr)) {
		$q=db_select($txt,__FILE__ . " linje " . __LINE__);
		while ($x<5 && ($r = db_fetch_array($q))) {
			if ($r['kontonr']) {
				$x++;
				// 20130221 htmlentities på beskrivelse:
				$retur.="<tr><td align=right>".$r['bilag']."</td><td>".dkdato($r['transdate'])."</td><td>".htmlentities($r['beskrivelse'],ENT_QUOTES,"$charset")."</td><td>".$r['kontonr']."</td></tr>";
			}
		}
		$retur.="</tbody></table>";
	}
		if ($x)
			return ($retur);
		else
			return (NULL);
} # endfunc sidste_5
##########################################################################################################
	function find_dublet($id, $transdate, $d_type, $debet, $k_type, $kredit, $amount, $faktura)
	{
	$qtxt = "select bilag,kladde_id from kassekladde where transdate='$transdate' and d_type='$d_type' and debet='$debet' ";
	$qtxt.= "and k_type='$k_type' and kredit='$kredit' and amount = '$amount' and faktura = '$faktura' and id!='$id' limit 1";
	if ($r=db_fetch_array(db_select($qtxt,__FILE__ . " linje " . __LINE__))) {
	return($r['bilag'].",".$r['kladde_id']);
		} else
			return ("0,0");
}

$x--;
	if (!$fokus && $x == 1)
		$fokus = "dato$x";
if (!$fokus && $x>1) {
	$x--;
	$fokus="besk$x";
}
print "</tbody></table>";
print "<script language=\"javascript\">";
	print "document.kassekladde.$fokus.focus()";
print "</script>";
	if ($menu == 'T') {
		include_once '../includes/topmenu/footer.php';
	} else {
		include_once '../includes/oldDesign/footer.php';
	}
?>
